<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pesten - Card Game</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      background-attachment: fixed;
      color: #fff;
      overflow-x: hidden;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      margin-bottom: 30px;
      border-bottom: 2px solid rgba(255,255,255,0.1);
      position: relative;
      z-index: 100;
    }

    .logo {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, #e94560, #ff6b6b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 30px rgba(233, 69, 96, 0.5);
    }

    /* User Profile Dropdown */
    .user-profile {
      position: relative;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 12px 6px 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 24px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .user-profile:hover {
      background: rgba(255,255,255,0.15);
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #e94560;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      overflow: hidden;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .user-info {
      display: flex;
      flex-direction: column;
    }

    .user-label {
      font-size: 10px;
      color: rgba(255,255,255,0.5);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .user-name {
      font-size: 13px;
      font-weight: 600;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .user-name::after {
      content: '‚ñº';
      font-size: 8px;
      color: rgba(255,255,255,0.5);
      transition: transform 0.2s;
    }

    .user-profile.open .user-name::after {
      transform: rotate(180deg);
    }

    .user-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: #1a1a2e;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 8px;
      min-width: 180px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.2s;
      z-index: 2000;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .user-profile.open .user-dropdown {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .user-profile.open::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1999;
      background: transparent;
    }

    .user-dropdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      color: rgba(255,255,255,0.7);
      font-size: 14px;
      text-decoration: none;
      transition: all 0.2s;
    }

    .user-dropdown-item:hover {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }

    .user-dropdown-item.logout {
      color: #ef4444;
    }

    .user-dropdown-item.logout:hover {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }

    .user-dropdown-item.active {
      background: rgba(233, 69, 96, 0.2);
      color: #e94560;
    }

    .back-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      color: #fff;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
      transition: all 0.3s ease;
      text-decoration: none;
    }

    .back-btn:hover {
      background: rgba(255,255,255,0.2);
    }

    /* Lobby */
    .lobby {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 30px;
    }

    .main-panel {
      background: rgba(255,255,255,0.05);
      border-radius: 20px;
      padding: 30px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .panel-title {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .btn {
      background: linear-gradient(135deg, #e94560, #ff6b6b);
      border: none;
      color: #fff;
      padding: 12px 25px;
      border-radius: 25px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s ease;
      box-shadow: 0 5px 20px rgba(233, 69, 96, 0.4);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(233, 69, 96, 0.6);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: rgba(255,255,255,0.1);
      box-shadow: none;
    }

    .btn-secondary:hover {
      background: rgba(255,255,255,0.2);
      box-shadow: none;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 0.9rem;
    }

    /* Room List */
    .room-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .room-card {
      background: rgba(255,255,255,0.08);
      border-radius: 15px;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .room-card:hover {
      background: rgba(255,255,255,0.12);
      transform: translateX(5px);
    }

    .room-info h3 {
      font-size: 1.1rem;
      margin-bottom: 5px;
    }

    .room-info p {
      color: rgba(255,255,255,0.6);
      font-size: 0.9rem;
    }

    .room-players {
      display: flex;
      gap: 5px;
      margin-top: 10px;
    }

    .room-player-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: linear-gradient(135deg, #e94560, #ff6b6b);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .room-player-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .no-rooms {
      text-align: center;
      padding: 50px;
      color: rgba(255,255,255,0.5);
    }

    /* Sidebar Leaderboard */
    .sidebar {
      background: rgba(255,255,255,0.05);
      border-radius: 20px;
      padding: 25px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      height: fit-content;
    }

    .sidebar-title {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .leaderboard-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .leaderboard-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
    }

    .leaderboard-rank {
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, #e94560, #ff6b6b);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.85rem;
      flex-shrink: 0;
    }

    .leaderboard-rank.gold { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #000; }
    .leaderboard-rank.silver { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #000; }
    .leaderboard-rank.bronze { background: linear-gradient(135deg, #cd7f32, #a0522d); }

    .leaderboard-info {
      flex: 1;
      min-width: 0;
    }

    .leaderboard-name {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .streak-badge {
      font-size: 0.9rem;
    }

    .leaderboard-stats {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
      margin-top: 2px;
    }

    .leaderboard-stats .stat-highlight {
      color: #e94560;
      font-weight: 600;
    }

    .leaderboard-score {
      text-align: right;
      flex-shrink: 0;
    }

    .leaderboard-wins {
      font-weight: 700;
      color: #e94560;
      font-size: 1rem;
    }

    .leaderboard-games {
      font-size: 0.7rem;
      color: rgba(255,255,255,0.5);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      border-radius: 20px;
      padding: 30px;
      width: 90%;
      max-width: 450px;
      border: 1px solid rgba(255,255,255,0.1);
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal {
      transform: scale(1);
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 25px;
      text-align: center;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 12px 18px;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      color: #fff;
      font-family: inherit;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #e94560;
    }

    .modal-buttons {
      display: flex;
      gap: 15px;
      margin-top: 25px;
    }

    .modal-buttons .btn {
      flex: 1;
    }

    /* Game Room Lobby */
    .room-lobby {
      display: none;
    }

    .room-lobby.active {
      display: block;
    }

    .room-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid rgba(255,255,255,0.1);
    }

    .room-title {
      font-size: 1.8rem;
      font-weight: 700;
    }

    .room-actions {
      display: flex;
      gap: 15px;
    }

    .players-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .player-slot {
      background: rgba(255,255,255,0.08);
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      border: 2px solid rgba(255,255,255,0.1);
      transition: all 0.3s ease;
    }

    .player-slot.host {
      border-color: #ffd700;
    }

    .player-slot.empty {
      border-style: dashed;
      opacity: 0.5;
    }

    .player-slot-avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      margin: 0 auto 15px;
      background: linear-gradient(135deg, #e94560, #ff6b6b);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
    }

    .player-slot-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .player-slot-name {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 5px;
    }

    .player-slot-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .player-slot-badge.host-badge {
      background: linear-gradient(135deg, #ffd700, #ffaa00);
      color: #000;
    }

    .player-slot-badge.bot-badge {
      background: rgba(255,255,255,0.2);
    }

    .remove-bot-btn {
      margin-top: 10px;
      padding: 5px 15px;
      font-size: 0.8rem;
      background: rgba(255,0,0,0.3);
      border: none;
      color: #fff;
      border-radius: 15px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .remove-bot-btn:hover {
      background: rgba(255,0,0,0.5);
    }

    /* Game View */
    .game-view {
      display: none;
    }

    .game-view.active {
      display: block;
    }

    .game-container {
      display: grid;
      grid-template-columns: 1fr 280px;
      gap: 20px;
      height: calc(100vh - 150px);
    }

    .game-area {
      background: rgba(255,255,255,0.05);
      border-radius: 20px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      border: 1px solid rgba(255,255,255,0.1);
    }

    /* Card Table */
    .card-table {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
      min-height: 400px;
    }

    .table-surface {
      flex: 1;
      background: radial-gradient(ellipse at center, #1a472a 0%, #0d2818 70%, #091a10 100%);
      border-radius: 50%;
      border: 12px solid #3d2314;
      box-shadow:
        inset 0 0 50px rgba(0,0,0,0.5),
        0 10px 30px rgba(0,0,0,0.5);
      position: relative;
      margin: 10px 40px;
      min-height: 300px;
    }

    /* Players around the table */
    .table-player {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: all 0.3s ease;
      max-width: 280px;
    }

    .table-player.top {
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
    }

    .table-player.top-left {
      top: 5%;
      left: 3%;
    }

    .table-player.top-right {
      top: 5%;
      right: 3%;
    }

    .table-player.left {
      top: 45%;
      left: -50px;
      transform: translateY(-50%);
    }

    .table-player.right {
      top: 45%;
      right: -50px;
      transform: translateY(-50%);
    }

    .table-player.current-turn {
      z-index: 10;
    }

    .table-player.current-turn .player-avatar-wrapper {
      box-shadow: 0 0 30px rgba(0, 255, 136, 0.9);
      border-color: #00ff88;
    }

    .player-avatar-wrapper {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: linear-gradient(135deg, #e94560, #ff6b6b);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      font-weight: 600;
      border: 4px solid #fff;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      overflow: hidden;
      transition: all 0.3s ease;
      position: relative;
    }

    .table-player.current-turn .player-avatar-wrapper {
      border-color: #00ff88;
    }

    .player-avatar-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .player-name-tag {
      background: rgba(0,0,0,0.85);
      padding: 6px 14px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-top: 8px;
      white-space: nowrap;
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Card count badge */
    .card-count-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      font-size: 0.85rem;
      font-weight: 700;
      min-width: 26px;
      height: 26px;
      border-radius: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 6px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.5);
      border: 2px solid rgba(255,255,255,0.4);
      z-index: 5;
    }

    .card-count-badge.low {
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      animation: lowCardPulse 1s infinite;
    }

    .card-count-badge.uno {
      background: linear-gradient(135deg, #f39c12, #e74c3c);
      animation: unoPulse 0.5s infinite;
    }

    @keyframes lowCardPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    @keyframes unoPulse {
      0%, 100% { transform: scale(1); box-shadow: 0 0 10px rgba(231, 76, 60, 0.8); }
      50% { transform: scale(1.2); box-shadow: 0 0 20px rgba(231, 76, 60, 1); }
    }

    /* Face-down cards for other players */
    .player-cards-fan {
      display: flex;
      justify-content: center;
      margin-top: 10px;
      min-height: 75px;
      position: relative;
    }

    .player-cards-row {
      display: flex;
      justify-content: center;
      position: relative;
      height: 72px;
    }

    .fan-card {
      width: 50px;
      height: 72px;
      background: linear-gradient(145deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      border-radius: 6px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1);
      position: absolute;
      transition: transform 0.2s ease, left 0.3s ease;
      border: 2px solid rgba(255,255,255,0.15);
      top: 0;
    }

    .fan-card::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 30px;
      height: 40px;
      background: linear-gradient(135deg, #e94560, #ff6b6b);
      border-radius: 4px;
      opacity: 0.9;
    }

    .fan-card::after {
      content: 'üé¥';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.4rem;
      opacity: 0.8;
    }

    .table-player.current-turn .fan-card {
      border-color: rgba(0, 255, 136, 0.5);
      box-shadow: 0 3px 15px rgba(0, 255, 136, 0.3);
    }

    /* No cards indicator */
    .no-cards-indicator {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.5);
      font-style: italic;
    }

    /* Center area with draw and discard piles */
    .table-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      gap: 30px;
      align-items: center;
    }

    .draw-pile, .discard-pile {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .pile-label {
      font-size: 0.7rem;
      color: rgba(255,255,255,0.7);
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .draw-pile .card {
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .draw-pile .card:hover:not(.disabled) {
      transform: translateY(-5px);
    }

    .draw-pile .card.disabled {
      cursor: not-allowed;
      opacity: 0.7;
    }

    .deck-count {
      position: absolute;
      bottom: -20px;
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
    }

    /* Game Info Bar */
    .game-info-bar {
      display: flex;
      justify-content: center;
      gap: 15px;
      padding: 10px;
      flex-wrap: wrap;
    }

    .info-chip {
      background: rgba(255,255,255,0.1);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .info-chip.warning {
      background: linear-gradient(135deg, #ff4444, #cc0000);
      animation: pulse 1s infinite;
    }

    .info-chip strong {
      color: #e94560;
    }

    /* Legacy table-area support */
    .table-area {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 40px;
    }

    /* Game Info */
    .game-info {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .info-item {
      background: rgba(255,255,255,0.1);
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 0.9rem;
    }

    .info-item strong {
      color: #e94560;
    }

    .pending-draws {
      background: linear-gradient(135deg, #ff4444, #cc0000) !important;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* Your Hand */
    .your-hand {
      background: rgba(0,0,0,0.3);
      border-radius: 20px;
      padding: 20px;
      margin-top: auto;
    }

    .hand-label {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.6);
      margin-bottom: 15px;
      text-align: center;
    }

    .hand-cards {
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
      min-height: 120px;
    }

    .hand-cards .card {
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }

    .hand-cards .card:hover:not(.disabled):not(.dragging) {
      transform: translateY(-15px);
    }

    .hand-cards .card.disabled {
      cursor: not-allowed;
      filter: brightness(0.5) saturate(0.3);
      opacity: 0.6;
    }

    .hand-cards .card.playable {
      box-shadow: 0 0 20px rgba(0, 255, 136, 0.7), 0 0 40px rgba(0, 255, 136, 0.3);
      border: 2px solid #00ff88;
      animation: playableGlow 1.5s ease-in-out infinite;
    }

    @keyframes playableGlow {
      0%, 100% { box-shadow: 0 0 20px rgba(0, 255, 136, 0.7), 0 0 40px rgba(0, 255, 136, 0.3); }
      50% { box-shadow: 0 0 30px rgba(0, 255, 136, 0.9), 0 0 60px rgba(0, 255, 136, 0.5); }
    }

    .hand-cards .card.playable:hover {
      transform: translateY(-20px) scale(1.05);
    }

    /* Drag and drop */
    .hand-cards .card.dragging {
      opacity: 0.5;
      transform: scale(0.95);
    }

    .hand-cards .card.drag-over {
      border-left: 3px solid #00ff88;
    }

    /* Sort controls */
    .hand-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .sort-btn {
      padding: 6px 12px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      color: rgba(255,255,255,0.8);
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .sort-btn:hover {
      background: rgba(255,255,255,0.2);
      border-color: #00ff88;
    }

    /* Card animations */
    .flying-card {
      position: fixed;
      z-index: 9999;
      pointer-events: none;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .flying-card.to-discard {
      animation: cardToDiscard 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    .flying-card.from-deck {
      animation: cardFromDeck 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    @keyframes cardToDiscard {
      0% {
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }
      50% {
        transform: scale(1.1) rotate(5deg);
      }
      100% {
        transform: scale(0.8) rotate(10deg);
        opacity: 0;
      }
    }

    @keyframes cardFromDeck {
      0% {
        transform: scale(0.8) rotate(-10deg);
        opacity: 0;
      }
      50% {
        transform: scale(1.1) rotate(5deg);
      }
      100% {
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }
    }

    /* Discard pile animation when card lands */
    .discard-pile.card-landing .card {
      animation: cardLand 0.4s ease-out;
    }

    @keyframes cardLand {
      0% {
        transform: scale(1.4) rotate(10deg);
        box-shadow: 0 0 30px rgba(0, 255, 136, 0.8);
      }
      50% {
        transform: scale(0.9) rotate(-5deg);
      }
      100% {
        transform: scale(1) rotate(0deg);
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      }
    }

    /* New card in hand animation */
    .hand-cards .card.new-card {
      animation: cardReceive 0.5s ease-out;
    }

    @keyframes cardReceive {
      0% {
        transform: translateY(-80px) scale(0.3) rotate(-30deg);
        opacity: 0;
        box-shadow: 0 0 40px rgba(0, 255, 136, 1);
      }
      50% {
        transform: translateY(10px) scale(1.15) rotate(5deg);
        box-shadow: 0 0 30px rgba(0, 255, 136, 0.8);
      }
      100% {
        transform: translateY(0) scale(1) rotate(0deg);
        opacity: 1;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      }
    }

    /* Card played from hand animation */
    .hand-cards .card.playing {
      animation: cardPlay 0.35s ease-in forwards;
      pointer-events: none;
    }

    @keyframes cardPlay {
      0% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
      50% {
        transform: translateY(-60px) scale(1.1);
        box-shadow: 0 0 25px rgba(233, 69, 96, 0.8);
      }
      100% {
        transform: translateY(-120px) scale(0.4);
        opacity: 0;
      }
    }

    /* Turn change highlight */
    .turn-indicator.your-turn-flash {
      animation: turnFlash 0.6s ease-out;
    }

    @keyframes turnFlash {
      0% {
        background: rgba(0, 255, 136, 1);
        transform: scale(1.2);
        box-shadow: 0 0 40px rgba(0, 255, 136, 0.9);
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        background: linear-gradient(135deg, #00ff88, #00cc6a);
        transform: scale(1);
        box-shadow: none;
      }
    }

    /* Draw pile bounce on draw */
    .draw-pile.drawing .card {
      animation: deckDraw 0.25s ease-out;
    }

    @keyframes deckDraw {
      0% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-15px) scale(1.05); }
      100% { transform: translateY(0) scale(1); }
    }

    .sort-btn.active {
      background: rgba(0, 255, 136, 0.2);
      border-color: #00ff88;
      color: #00ff88;
    }

    /* Cards */
    .card {
      width: 70px;
      height: 100px;
      border-radius: 8px;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 700;
      position: relative;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .card.back {
      background: linear-gradient(135deg, #e94560, #ff6b6b);
      background-image: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 10px,
        rgba(255,255,255,0.1) 10px,
        rgba(255,255,255,0.1) 20px
      );
    }

    .card.hearts, .card.diamonds { color: #e94560; }
    .card.clubs, .card.spades { color: #1a1a2e; }
    .card.joker {
      background: linear-gradient(135deg, #ffd700, #ff6b6b, #00ff88, #00bfff);
      color: #fff;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }

    .card-rank {
      position: absolute;
      top: 5px;
      left: 8px;
      font-size: 0.9rem;
    }

    .card-suit {
      font-size: 2rem;
    }

    .card-rank-bottom {
      position: absolute;
      bottom: 5px;
      right: 8px;
      font-size: 0.9rem;
      transform: rotate(180deg);
    }

    /* Suit Selector Modal */
    .suit-selector {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .suit-option {
      padding: 25px;
      border-radius: 15px;
      background: rgba(255,255,255,0.1);
      border: 2px solid transparent;
      cursor: pointer;
      font-size: 3rem;
      text-align: center;
      transition: all 0.3s ease;
    }

    .suit-option:hover {
      background: rgba(255,255,255,0.2);
      border-color: #e94560;
    }

    .suit-option.hearts, .suit-option.diamonds { color: #e94560; }
    .suit-option.clubs, .suit-option.spades { color: #fff; }

    /* Game Sidebar */
    .game-sidebar {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .game-log {
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      padding: 15px;
      flex: 1;
      overflow-y: auto;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .log-title {
      font-weight: 600;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .log-messages {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 0.85rem;
    }

    .log-message {
      padding: 8px 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      color: rgba(255,255,255,0.8);
    }

    /* Turn indicator */
    .turn-indicator {
      background: linear-gradient(135deg, #00ff88, #00cc6a);
      color: #000;
      padding: 15px;
      border-radius: 15px;
      text-align: center;
      font-weight: 700;
      animation: glow 2s infinite;
    }

    .turn-indicator.waiting {
      background: rgba(255,255,255,0.1);
      color: #fff;
      animation: none;
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 20px rgba(0, 255, 136, 0.5); }
      50% { box-shadow: 0 0 30px rgba(0, 255, 136, 0.8); }
    }

    /* Turn Timer */
    .turn-timer {
      margin-top: 10px;
      padding: 10px;
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      text-align: center;
    }

    .timer-bar {
      height: 8px;
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .timer-fill {
      height: 100%;
      background: linear-gradient(90deg, #00ff88, #00cc6a);
      border-radius: 4px;
      transition: width 0.5s linear;
    }

    .timer-fill.warning {
      background: linear-gradient(90deg, #ffaa00, #ff8800);
    }

    .timer-fill.danger {
      background: linear-gradient(90deg, #ff4444, #cc0000);
      animation: timerPulse 0.5s infinite;
    }

    @keyframes timerPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .timer-text {
      font-size: 1.2rem;
      font-weight: 700;
      color: #fff;
    }

    .timer-text.warning {
      color: #ffaa00;
    }

    .timer-text.danger {
      color: #ff4444;
      animation: timerPulse 0.5s infinite;
    }

    /* Winner Modal */
    .winner-content {
      text-align: center;
      padding: 20px;
    }

    .winner-trophy {
      font-size: 5rem;
      margin-bottom: 20px;
      animation: bounce 1s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }

    .winner-name {
      font-size: 2rem;
      font-weight: 700;
      color: #ffd700;
      margin-bottom: 10px;
    }

    /* Rules Info */
    .rules-info {
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      padding: 15px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .rules-title {
      font-weight: 600;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .rules-list {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.7);
    }

    .rules-list div {
      margin-bottom: 5px;
    }

    .rules-list strong {
      color: #e94560;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .lobby {
        grid-template-columns: 1fr;
      }

      .game-container {
        grid-template-columns: 1fr;
        height: auto;
      }

      .game-sidebar {
        order: -1;
      }

      .card {
        width: 55px;
        height: 80px;
        font-size: 1.2rem;
      }

      .card-rank { font-size: 0.7rem; }
      .card-suit { font-size: 1.5rem; }

      .table-surface {
        margin: 10px 15px;
        min-height: 250px;
        border-width: 8px;
      }

      .table-player {
        transform: scale(0.8);
      }

      .table-player.top { top: -20px; }
      .table-player.left { left: -30px; }
      .table-player.right { right: -30px; }

      .player-avatar-wrapper {
        width: 55px;
        height: 55px;
        font-size: 1.3rem;
      }

      .player-name-tag {
        font-size: 0.7rem;
        padding: 4px 10px;
      }

      .fan-card {
        width: 38px;
        height: 55px;
      }

      .fan-card::before {
        width: 22px;
        height: 30px;
      }

      .fan-card::after {
        font-size: 1rem;
      }

      .player-cards-row {
        height: 55px;
      }

      .player-cards-fan {
        min-height: 58px;
      }

      .card-count-badge {
        font-size: 0.7rem;
        min-width: 22px;
        height: 22px;
      }

      .table-center {
        gap: 20px;
      }

      .game-info-bar {
        gap: 8px;
      }

      .info-chip {
        padding: 4px 10px;
        font-size: 0.7rem;
      }
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-size: 1.5rem;
    }

    .loading::after {
      content: '';
      width: 30px;
      height: 30px;
      border: 3px solid rgba(255,255,255,0.2);
      border-top-color: #e94560;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 15px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Hidden */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- SVG Icons -->
  <svg style="display:none;">
    <symbol id="icon-stats" viewBox="0 0 24 24">
      <path fill="currentColor" d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/>
    </symbol>
    <symbol id="icon-pictionary" viewBox="0 0 24 24">
      <path fill="currentColor" d="M18 4V3c0-.55-.45-1-1-1H5c-.55 0-1 .45-1 1v4c0 .55.45 1 1 1h12c.55 0 1-.45 1-1V6h1v4H9v11c0 .55.45 1 1 1h2c.55 0 1-.45 1-1v-9h8V4h-3z"/>
    </symbol>
    <symbol id="icon-hitster" viewBox="0 0 24 24">
      <path fill="currentColor" d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
    </symbol>
    <symbol id="icon-pesten" viewBox="0 0 24 24">
      <path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14l-5-5 1.41-1.41L12 14.17l4.59-4.58L18 11l-6 6z"/>
    </symbol>
    <symbol id="icon-music" viewBox="0 0 24 24">
      <path fill="currentColor" d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
    </symbol>
  </svg>

  <div id="app" class="loading">Loading...</div>

  <script>
    const SUITS = ['hearts', 'diamonds', 'clubs', 'spades'];
    const SUIT_SYMBOLS = {
      hearts: '‚ô•',
      diamonds: '‚ô¶',
      clubs: '‚ô£',
      spades: '‚ô†',
      joker: 'üÉè'
    };

    let ws = null;
    let currentUser = null;
    let currentRoom = null;
    let gameState = null;
    let pendingJackCard = null;

    // Initialize
    async function init() {
      try {
        const response = await fetch('/api/me');
        if (!response.ok) {
          window.location.href = '/login';
          return;
        }
        const userData = await response.json();
        // Transform to expected format
        currentUser = {
          id: userData.id,
          displayName: userData.username,
          avatar: userData.avatar
            ? `https://cdn.discordapp.com/avatars/${userData.id}/${userData.avatar}.png`
            : `https://cdn.discordapp.com/embed/avatars/${parseInt(userData.id) % 5}.png`
        };
        connectWebSocket();
        renderLobby();
      } catch (error) {
        console.error('Init error:', error);
        window.location.href = '/login';
      }
    }

    // WebSocket connection
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}`);

      ws.onopen = () => {
        console.log('WebSocket connected');
        ws.send(JSON.stringify({ type: 'pesten:getRooms' }));
        ws.send(JSON.stringify({ type: 'pesten:getLeaderboard' }));

        // Try to rejoin room if we were in one
        const savedRoomId = sessionStorage.getItem('pestenRoomId');
        if (savedRoomId) {
          console.log('Attempting to rejoin room:', savedRoomId);
          ws.send(JSON.stringify({ type: 'pesten:rejoinRoom', roomId: savedRoomId }));
        }
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleMessage(data);
      };

      ws.onclose = () => {
        console.log('WebSocket disconnected, reconnecting...');
        setTimeout(connectWebSocket, 2000);
      };
    }

    function handleMessage(data) {
      switch (data.type) {
        case 'pesten:roomList':
          renderRoomList(data.rooms);
          break;
        case 'pesten:leaderboard':
          renderLeaderboard(data.leaderboard);
          break;
        case 'pesten:roomCreated':
        case 'pesten:roomJoined':
        case 'pesten:rejoined':
          currentRoom = data.room;
          sessionStorage.setItem('pestenRoomId', currentRoom.id);
          // Initialize animation tracking state
          initAnimationState(currentRoom);
          if (currentRoom.gameState === 'playing') {
            gameState = currentRoom;
            renderGame();
            // Start turn timer if applicable
            if (gameState.turnTimeLimit && gameState.turnTimeLimit < 9999) {
              startTurnTimer(gameState.turnTimeRemaining || gameState.turnTimeLimit, gameState.turnTimeLimit);
            }
          } else if (currentRoom.gameState === 'finished') {
            gameState = currentRoom;
            renderGame();
            showWinnerModal();
          } else {
            renderRoomLobby();
          }
          break;
        case 'pesten:roomUpdated':
          currentRoom = data.room;
          if (currentRoom.gameState === 'playing') {
            detectAnimations(currentRoom);
            gameState = currentRoom;
            renderGame();
            applyPendingAnimations();
            // Start turn timer if applicable
            if (gameState.turnTimeLimit && gameState.turnTimeLimit < 9999) {
              startTurnTimer(gameState.turnTimeRemaining || gameState.turnTimeLimit, gameState.turnTimeLimit);
            }
          } else if (currentRoom.gameState === 'finished') {
            gameState = currentRoom;
            clearTurnTimer();
            renderGame();
            showWinnerModal();
          } else {
            clearTurnTimer();
            renderRoomLobby();
          }
          break;
        case 'pesten:gameState':
          detectAnimations(data.state);
          gameState = data.state;
          renderGame();
          applyPendingAnimations();
          if (gameState.gameState === 'finished') {
            clearTurnTimer();
            showWinnerModal();
          } else if (gameState.gameState === 'playing' && gameState.turnTimeLimit && gameState.turnTimeLimit < 9999) {
            startTurnTimer(gameState.turnTimeRemaining || gameState.turnTimeLimit, gameState.turnTimeLimit);
          }
          break;
        case 'pesten:error':
          alert(data.message);
          break;
        case 'pesten:roomLeft':
          currentRoom = null;
          gameState = null;
          sessionStorage.removeItem('pestenRoomId');
          renderLobby();
          ws.send(JSON.stringify({ type: 'pesten:getRooms' }));
          break;
        case 'pesten:rejoinFailed':
          // Room no longer exists or player was removed
          sessionStorage.removeItem('pestenRoomId');
          renderLobby();
          break;
        case 'pesten:needsSuit':
          showSuitSelector();
          break;
        case 'pesten:turnTimeout':
          // Someone's turn timed out - they auto-drew cards
          detectAnimations(data.room);
          gameState = data.room;
          addToGameLog(`${getPlayerName(data.playerId)} ran out of time and drew ${data.drawCount} card${data.drawCount > 1 ? 's' : ''}!`);
          renderGame();
          applyPendingAnimations();
          // Start timer for next turn
          if (gameState.turnTimeLimit && gameState.turnTimeLimit < 9999 && gameState.gameState === 'playing') {
            startTurnTimer(gameState.turnTimeRemaining || gameState.turnTimeLimit, gameState.turnTimeLimit);
          }
          break;
      }
    }

    // Turn timer
    let turnTimerInterval = null;
    let turnTimeRemaining = 0;
    let turnTimeLimit = 30;

    function startTurnTimer(timeRemaining, timeLimit) {
      clearTurnTimer();
      turnTimeRemaining = Math.ceil(timeRemaining);
      turnTimeLimit = timeLimit;
      updateTimerDisplay();

      turnTimerInterval = setInterval(() => {
        turnTimeRemaining = Math.max(0, turnTimeRemaining - 1);
        updateTimerDisplay();
        if (turnTimeRemaining <= 0) {
          clearTurnTimer();
        }
      }, 1000);
    }

    function clearTurnTimer() {
      if (turnTimerInterval) {
        clearInterval(turnTimerInterval);
        turnTimerInterval = null;
      }
    }

    function updateTimerDisplay() {
      const timerFill = document.getElementById('timerFill');
      const timerText = document.getElementById('timerText');
      if (!timerFill || !timerText) return;

      const percentage = (turnTimeRemaining / turnTimeLimit) * 100;
      timerFill.style.width = percentage + '%';
      timerText.textContent = turnTimeRemaining + 's';

      // Update classes for warning/danger states
      timerFill.classList.remove('warning', 'danger');
      timerText.classList.remove('warning', 'danger');

      if (turnTimeRemaining <= 5) {
        timerFill.classList.add('danger');
        timerText.classList.add('danger');
      } else if (turnTimeRemaining <= 10) {
        timerFill.classList.add('warning');
        timerText.classList.add('warning');
      }
    }

    function getPlayerName(playerId) {
      if (!gameState) return 'Unknown';
      const player = gameState.players.find(p => p.id === playerId);
      return player ? player.name : 'Unknown';
    }

    function addToGameLog(message) {
      if (!gameState) return;
      if (!gameState.gameLog) gameState.gameLog = [];
      gameState.gameLog.push({ message, timestamp: Date.now() });
    }

    // Render functions
    function renderLobby() {
      document.getElementById('app').className = '';
      document.getElementById('app').innerHTML = `
        <div class="container">
          <div class="header">
            <div class="logo">üÉè Pesten</div>
            <div style="display: flex; gap: 15px; align-items: center;">
              <a href="/" class="back-btn">‚Üê Back</a>
              <div class="user-profile" onclick="toggleUserDropdown(event)">
                <div class="user-avatar">
                  <img src="${currentUser.avatar}" alt="Avatar">
                </div>
                <div class="user-info">
                  <span class="user-label">Logged in as</span>
                  <span class="user-name">${currentUser.displayName}</span>
                </div>
                <div class="user-dropdown">
                  <a href="/" class="user-dropdown-item">
                    <svg style="width:16px;height:16px;"><use href="#icon-music"/></svg>
                    Music Player
                  </a>
                  <a href="/stats" class="user-dropdown-item">
                    <svg style="width:16px;height:16px;"><use href="#icon-stats"/></svg>
                    Listening Stats
                  </a>
                  <a href="/pictionary" class="user-dropdown-item">
                    <svg style="width:16px;height:16px;"><use href="#icon-pictionary"/></svg>
                    Pictionary Game
                  </a>
                  <a href="/hitster" class="user-dropdown-item">
                    <svg style="width:16px;height:16px;"><use href="#icon-hitster"/></svg>
                    Hitster Music Game
                  </a>
                  <a href="/pesten" class="user-dropdown-item active">
                    <svg style="width:16px;height:16px;"><use href="#icon-pesten"/></svg>
                    Pesten Card Game
                  </a>
                  <a href="/logout" class="user-dropdown-item logout">
                    üö™ Logout
                  </a>
                </div>
              </div>
            </div>
          </div>

          <div class="lobby">
            <div class="main-panel">
              <div class="panel-header">
                <h2 class="panel-title">Game Rooms</h2>
                <button class="btn" onclick="showCreateModal()">+ Create Room</button>
              </div>
              <div class="room-list" id="roomList">
                <div class="no-rooms">No rooms available. Create one!</div>
              </div>
            </div>

            <div class="sidebar">
              <h3 class="sidebar-title">üèÜ Leaderboard</h3>
              <div class="leaderboard-list" id="leaderboard">
                <div style="color: rgba(255,255,255,0.5); text-align: center;">Loading...</div>
              </div>

              <div class="rules-info" style="margin-top: 20px;">
                <div class="rules-title">üìú Special Cards</div>
                <div class="rules-list">
                  <div><strong>2</strong> - Next player draws 2 (stackable)</div>
                  <div><strong>7</strong> - Play again</div>
                  <div><strong>8</strong> - Skip next player</div>
                  <div><strong>J</strong> - Wild, choose suit</div>
                  <div><strong>A</strong> - Reverse direction</div>
                  <div><strong>üÉè</strong> - Next player draws 5 (stackable)</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-overlay" id="createModal">
          <div class="modal">
            <h3 class="modal-title">Create Room</h3>
            <div class="form-group">
              <label>Room Name</label>
              <input type="text" id="roomName" placeholder="Enter room name" maxlength="30">
            </div>
            <div class="form-group">
              <label>Max Players</label>
              <select id="maxPlayers">
                <option value="2">2 Players</option>
                <option value="3">3 Players</option>
                <option value="4" selected>4 Players</option>
                <option value="5">5 Players</option>
                <option value="6">6 Players</option>
              </select>
            </div>
            <div class="form-group">
              <label>Turn Time Limit</label>
              <select id="turnTimeLimit">
                <option value="15">15 seconds</option>
                <option value="30" selected>30 seconds</option>
                <option value="45">45 seconds</option>
                <option value="60">60 seconds</option>
                <option value="0">No limit</option>
              </select>
            </div>
            <div class="modal-buttons">
              <button class="btn btn-secondary" onclick="hideCreateModal()">Cancel</button>
              <button class="btn" onclick="createRoom()">Create</button>
            </div>
          </div>
        </div>
      `;
    }

    function renderRoomList(rooms) {
      const container = document.getElementById('roomList');
      if (!container) return;

      if (rooms.length === 0) {
        container.innerHTML = '<div class="no-rooms">No rooms available. Create one!</div>';
        return;
      }

      container.innerHTML = rooms.map(room => `
        <div class="room-card">
          <div class="room-info">
            <h3>${escapeHtml(room.name)}</h3>
            <p>${room.playerCount}/${room.maxPlayers} players</p>
            <div class="room-players">
              ${room.players.map(p => `
                <div class="room-player-avatar" title="${escapeHtml(p.name)}">
                  ${p.avatar ? `<img src="${p.avatar}" alt="">` : (p.isBot ? 'ü§ñ' : p.name[0])}
                </div>
              `).join('')}
            </div>
          </div>
          <button class="btn" onclick="joinRoom('${room.id}')" ${room.playerCount >= room.maxPlayers ? 'disabled' : ''}>
            Join
          </button>
        </div>
      `).join('');
    }

    function renderLeaderboard(leaderboard) {
      const container = document.getElementById('leaderboard');
      if (!container) return;

      if (leaderboard.length === 0) {
        container.innerHTML = '<div style="color: rgba(255,255,255,0.5); text-align: center;">No games played yet</div>';
        return;
      }

      container.innerHTML = leaderboard.map((player, index) => `
        <div class="leaderboard-item">
          <div class="leaderboard-rank ${index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : ''}">${index + 1}</div>
          <div class="leaderboard-info">
            <div class="leaderboard-name">
              ${escapeHtml(player.displayName)}
              ${player.winStreak >= 3 ? '<span class="streak-badge" title="On a winning streak!">üî•</span>' : ''}
            </div>
            <div class="leaderboard-stats">
              <span class="stat-highlight">${player.winRate}%</span> win rate ¬∑
              <span class="stat-highlight">${player.avgDrawsForced || 0}</span> avg draws forced
            </div>
          </div>
          <div class="leaderboard-score">
            <div class="leaderboard-wins">${player.gamesWon}W</div>
            <div class="leaderboard-games">${player.gamesPlayed} games</div>
          </div>
        </div>
      `).join('');
    }

    function renderRoomLobby() {
      document.getElementById('app').innerHTML = `
        <div class="container">
          <div class="header">
            <div class="logo">üÉè Pesten</div>
            <div class="user-profile" onclick="toggleUserDropdown(event)">
              <div class="user-avatar">
                <img src="${currentUser.avatar}" alt="Avatar">
              </div>
              <div class="user-info">
                <span class="user-label">Logged in as</span>
                <span class="user-name">${currentUser.displayName}</span>
              </div>
              <div class="user-dropdown">
                <a href="/" class="user-dropdown-item">
                  <svg style="width:16px;height:16px;"><use href="#icon-music"/></svg>
                  Music Player
                </a>
                <a href="/stats" class="user-dropdown-item">
                  <svg style="width:16px;height:16px;"><use href="#icon-stats"/></svg>
                  Listening Stats
                </a>
                <a href="/pictionary" class="user-dropdown-item">
                  <svg style="width:16px;height:16px;"><use href="#icon-pictionary"/></svg>
                  Pictionary Game
                </a>
                <a href="/hitster" class="user-dropdown-item">
                  <svg style="width:16px;height:16px;"><use href="#icon-hitster"/></svg>
                  Hitster Music Game
                </a>
                <a href="/pesten" class="user-dropdown-item active">
                  <svg style="width:16px;height:16px;"><use href="#icon-pesten"/></svg>
                  Pesten Card Game
                </a>
                <a href="/logout" class="user-dropdown-item logout">
                  üö™ Logout
                </a>
              </div>
            </div>
          </div>

          <div class="main-panel">
            <div class="room-header">
              <h2 class="room-title">${escapeHtml(currentRoom.name)}</h2>
              <div class="room-actions">
                ${currentRoom.hostId === currentUser.id ? `
                  <button class="btn btn-secondary" onclick="addBot()">+ Add Bot</button>
                  <button class="btn" onclick="startGame()" ${currentRoom.players.length < 2 ? 'disabled' : ''}>
                    Start Game
                  </button>
                ` : ''}
                <button class="btn btn-secondary" onclick="leaveRoom()">Leave</button>
              </div>
            </div>

            <div class="players-grid">
              ${currentRoom.players.map(player => `
                <div class="player-slot ${player.id === currentRoom.hostId ? 'host' : ''}">
                  <div class="player-slot-avatar">
                    ${player.avatar ? `<img src="${player.avatar}" alt="">` : (player.isBot ? 'ü§ñ' : player.name[0])}
                  </div>
                  <div class="player-slot-name">${escapeHtml(player.name)}</div>
                  ${player.id === currentRoom.hostId ? '<span class="player-slot-badge host-badge">Host</span>' : ''}
                  ${player.isBot ? '<span class="player-slot-badge bot-badge">Bot</span>' : ''}
                  ${player.isBot && currentRoom.hostId === currentUser.id ? `
                    <button class="remove-bot-btn" onclick="removeBot('${player.id}')">Remove</button>
                  ` : ''}
                </div>
              `).join('')}
              ${Array(currentRoom.maxPlayers - currentRoom.players.length).fill().map(() => `
                <div class="player-slot empty">
                  <div class="player-slot-avatar">?</div>
                  <div class="player-slot-name">Waiting...</div>
                </div>
              `).join('')}
            </div>

            <div class="rules-info">
              <div class="rules-title">üìú How to Play</div>
              <div class="rules-list">
                <div>Match the top card by <strong>suit</strong> or <strong>rank</strong></div>
                <div>Can't play? Click the deck to draw a card</div>
                <div>First player to empty their hand wins!</div>
                <div style="margin-top: 10px;"><strong>Special Cards:</strong> 2 (draw 2), 7 (play again), 8 (skip), J (wild), A (reverse), üÉè (draw 5)</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderGame() {
      if (!gameState) return;

      const myPlayer = gameState.players.find(p => p.id === currentUser.id);
      const otherPlayers = gameState.players.filter(p => p.id !== currentUser.id);
      const currentPlayer = gameState.players[gameState.currentPlayerIndex];
      const isMyTurn = currentPlayer.id === currentUser.id;

      document.getElementById('app').innerHTML = `
        <div class="container">
          <div class="header">
            <div class="logo">üÉè Pesten</div>
            <div style="display: flex; gap: 15px; align-items: center;">
              <button class="btn btn-secondary btn-small" onclick="leaveRoom()">Leave Game</button>
              <div class="user-profile" onclick="toggleUserDropdown(event)">
                <div class="user-avatar">
                  <img src="${currentUser.avatar}" alt="Avatar">
                </div>
                <div class="user-info">
                  <span class="user-label">Logged in as</span>
                  <span class="user-name">${currentUser.displayName}</span>
                </div>
                <div class="user-dropdown">
                  <a href="/" class="user-dropdown-item">
                    <svg style="width:16px;height:16px;"><use href="#icon-music"/></svg>
                    Music Player
                  </a>
                  <a href="/stats" class="user-dropdown-item">
                    <svg style="width:16px;height:16px;"><use href="#icon-stats"/></svg>
                    Listening Stats
                  </a>
                  <a href="/pictionary" class="user-dropdown-item">
                    <svg style="width:16px;height:16px;"><use href="#icon-pictionary"/></svg>
                    Pictionary Game
                  </a>
                  <a href="/hitster" class="user-dropdown-item">
                    <svg style="width:16px;height:16px;"><use href="#icon-hitster"/></svg>
                    Hitster Music Game
                  </a>
                  <a href="/pesten" class="user-dropdown-item active">
                    <svg style="width:16px;height:16px;"><use href="#icon-pesten"/></svg>
                    Pesten Card Game
                  </a>
                  <a href="/logout" class="user-dropdown-item logout">
                    üö™ Logout
                  </a>
                </div>
              </div>
            </div>
          </div>

          <div class="game-container">
            <div class="game-area">
              <!-- Game info bar -->
              <div class="game-info-bar">
                <div class="info-chip">
                  ${gameState.direction === 1 ? '‚Üª' : '‚Ü∫'} <strong>${gameState.direction === 1 ? 'Clockwise' : 'Counter'}</strong>
                </div>
                ${gameState.chosenSuit ? `<div class="info-chip">Suit: <strong>${SUIT_SYMBOLS[gameState.chosenSuit]}</strong></div>` : ''}
                ${gameState.pendingDraws > 0 ? `<div class="info-chip warning">‚ö†Ô∏è Draw ${gameState.pendingDraws}!</div>` : ''}
              </div>

              <!-- Card Table -->
              <div class="card-table">
                <div class="table-surface">
                  <!-- Other players positioned around the table -->
                  ${renderTablePlayers(otherPlayers)}

                  <!-- Center area with piles -->
                  <div class="table-center">
                    <div class="draw-pile">
                      <div class="pile-label">Draw</div>
                      <div class="card back ${!isMyTurn || gameState.gameState === 'finished' ? 'disabled' : ''}"
                           onclick="${isMyTurn && gameState.gameState === 'playing' ? 'drawCard()' : ''}">
                      </div>
                      <div class="deck-count">${gameState.deckCount}</div>
                    </div>

                    <div class="discard-pile">
                      <div class="pile-label">Discard</div>
                      ${renderCard(gameState.topCard)}
                    </div>
                  </div>
                </div>
              </div>

              <!-- Your hand -->
              <div class="your-hand">
                <div class="hand-label">Your Hand (${myPlayer?.hand?.length || 0} cards)</div>
                <div class="hand-controls">
                  <button class="sort-btn ${currentSort === 'suit' ? 'active' : ''}" onclick="sortHand('suit')">Sort by Suit</button>
                  <button class="sort-btn ${currentSort === 'rank' ? 'active' : ''}" onclick="sortHand('rank')">Sort by Rank</button>
                  <button class="sort-btn" onclick="sortHand('none')">Reset Order</button>
                </div>
                <div class="hand-cards" id="handCards">
                  ${getDisplayHand(myPlayer?.hand || []).map((card, index) => {
                    const canPlay = isMyTurn && gameState.gameState === 'playing' && canPlayCard(card);
                    const isDisabled = !isMyTurn || gameState.gameState === 'finished';
                    return `
                      <div class="card ${card.suit} ${isDisabled ? 'disabled' : ''} ${canPlay ? 'playable' : ''}"
                           draggable="${!isDisabled}"
                           data-card-id="${card.id}"
                           data-index="${index}"
                           onclick="${canPlay ? `playCard('${card.id}')` : ''}"
                           ondragstart="handleDragStart(event)"
                           ondragover="handleDragOver(event)"
                           ondragenter="handleDragEnter(event)"
                           ondragleave="handleDragLeave(event)"
                           ondrop="handleDrop(event)"
                           ondragend="handleDragEnd(event)">
                        ${renderCardContent(card)}
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            </div>

            <!-- Sidebar -->
            <div class="game-sidebar">
              <div class="turn-indicator ${isMyTurn ? '' : 'waiting'}">
                ${gameState.gameState === 'finished'
                  ? `üéâ ${escapeHtml(gameState.winner.name)} wins!`
                  : (isMyTurn ? 'üéØ Your Turn!' : `Waiting for ${escapeHtml(currentPlayer.name)}...`)}
              </div>

              ${gameState.turnTimeLimit && gameState.turnTimeLimit < 9999 && gameState.gameState === 'playing' ? `
                <div class="turn-timer">
                  <div class="timer-bar">
                    <div class="timer-fill" id="timerFill" style="width: 100%"></div>
                  </div>
                  <div class="timer-text" id="timerText">${Math.ceil(gameState.turnTimeRemaining || gameState.turnTimeLimit)}s</div>
                </div>
              ` : ''}

              <div class="game-log">
                <div class="log-title">Game Log</div>
                <div class="log-messages">
                  ${gameState.gameLog.map(log => `
                    <div class="log-message">${escapeHtml(log.message)}</div>
                  `).join('')}
                </div>
              </div>

              <div class="rules-info">
                <div class="rules-title">üìú Quick Reference</div>
                <div class="rules-list">
                  <div><strong>2</strong> Draw 2 | <strong>7</strong> Play again</div>
                  <div><strong>8</strong> Skip | <strong>J</strong> Wild</div>
                  <div><strong>A</strong> Reverse | <strong>üÉè</strong> Draw 5</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-overlay" id="suitModal">
          <div class="modal">
            <h3 class="modal-title">Choose a Suit</h3>
            <div class="suit-selector">
              <div class="suit-option hearts" onclick="selectSuit('hearts')">‚ô•</div>
              <div class="suit-option diamonds" onclick="selectSuit('diamonds')">‚ô¶</div>
              <div class="suit-option clubs" onclick="selectSuit('clubs')">‚ô£</div>
              <div class="suit-option spades" onclick="selectSuit('spades')">‚ô†</div>
            </div>
          </div>
        </div>

        <div class="modal-overlay" id="winnerModal">
          <div class="modal">
            <div class="winner-content">
              <div class="winner-trophy">üèÜ</div>
              <div class="winner-name">${gameState.winner ? escapeHtml(gameState.winner.name) : ''}</div>
              <div>wins the game!</div>
              <div class="modal-buttons" style="margin-top: 30px;">
                <button class="btn" onclick="leaveRoom()">Back to Lobby</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function getTablePositions(playerCount) {
      // Positions for other players around the table
      switch (playerCount) {
        case 1: return ['top'];
        case 2: return ['top-left', 'top-right'];
        case 3: return ['left', 'top', 'right'];
        case 4: return ['left', 'top-left', 'top-right', 'right'];
        case 5: return ['left', 'top-left', 'top', 'top-right', 'right'];
        default: return ['left', 'top-left', 'top', 'top-right', 'right'];
      }
    }

    function renderTablePlayers(players) {
      const positions = getTablePositions(players.length);

      return players.map((player, index) => {
        const position = positions[index] || 'top';
        const isCurrent = player.isCurrentTurn;
        const cardCount = player.cardCount || 0;

        // Create fan of cards
        const cardFan = renderCardFan(cardCount);

        // Card count badge classes
        let badgeClass = 'card-count-badge';
        if (cardCount === 1) badgeClass += ' uno';
        else if (cardCount <= 3) badgeClass += ' low';

        return `
          <div class="table-player ${position} ${isCurrent ? 'current-turn' : ''}">
            <div class="player-avatar-wrapper">
              ${player.avatar ? `<img src="${player.avatar}" alt="">` : (player.isBot ? 'ü§ñ' : player.name[0].toUpperCase())}
              <div class="${badgeClass}">${cardCount}</div>
            </div>
            <div class="player-name-tag">${escapeHtml(player.name)}</div>
            <div class="player-cards-fan">
              ${cardFan}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderCardFan(cardCount) {
      if (cardCount === 0) return '<div class="no-cards-indicator">No cards</div>';

      // Calculate overlap - more cards = more overlap
      // Card width is 50px, we want them to fit in ~200px max width
      const cardWidth = 50;
      const maxWidth = 220;

      // Calculate spacing: for few cards, spread them out; for many, overlap more
      let spacing;
      if (cardCount <= 3) {
        spacing = cardWidth + 4; // Small gap between cards
      } else if (cardCount <= 5) {
        spacing = 35; // Slight overlap
      } else if (cardCount <= 8) {
        spacing = 25; // More overlap
      } else if (cardCount <= 12) {
        spacing = 18; // Heavy overlap
      } else {
        spacing = Math.max(12, (maxWidth - cardWidth) / (cardCount - 1)); // Very tight
      }

      const totalWidth = cardWidth + (spacing * (cardCount - 1));
      const startOffset = -totalWidth / 2 + cardWidth / 2;

      let cards = `<div class="player-cards-row" style="width: ${totalWidth + 10}px;">`;
      for (let i = 0; i < cardCount; i++) {
        const leftPos = startOffset + (i * spacing);
        cards += `<div class="fan-card" style="left: calc(50% + ${leftPos}px); z-index: ${i};"></div>`;
      }
      cards += '</div>';

      return cards;
    }

    function renderCard(card) {
      if (!card) return '<div class="card back"></div>';
      return `
        <div class="card ${card.suit}">
          ${renderCardContent(card)}
        </div>
      `;
    }

    function renderCardContent(card) {
      if (card.suit === 'joker') {
        return '<div class="card-suit">üÉè</div>';
      }
      return `
        <div class="card-rank">${card.rank}</div>
        <div class="card-suit">${SUIT_SYMBOLS[card.suit]}</div>
        <div class="card-rank-bottom">${card.rank}</div>
      `;
    }

    function canPlayCard(card) {
      if (!gameState || gameState.gameState !== 'playing') return false;

      const topCard = gameState.topCard;
      const pendingDraws = gameState.pendingDraws;
      const chosenSuit = gameState.chosenSuit;

      // If there are pending draws, only matching draw cards can be played
      if (pendingDraws > 0) {
        if (topCard.rank === '2' || topCard.suit === 'joker') {
          if (topCard.rank === '2' && card.rank === '2') return true;
          if (card.suit === 'joker') return true;
          if (topCard.suit === 'joker' && card.rank === '2') return true;
          return false;
        }
      }

      // Joker can always be played
      if (card.suit === 'joker') return true;

      // Jack (wild) can always be played
      if (card.rank === 'J') return true;

      // If top card is a Joker (and no pending draws), any card can be played
      if (topCard.suit === 'joker') return true;

      // If a suit was chosen (after Jack), must match that suit
      if (chosenSuit) {
        return card.suit === chosenSuit || card.rank === 'J';
      }

      // Match by suit or rank
      return card.suit === topCard.suit || card.rank === topCard.rank;
    }

    // Actions
    function showCreateModal() {
      document.getElementById('createModal').classList.add('active');
      document.getElementById('roomName').focus();
    }

    function hideCreateModal() {
      document.getElementById('createModal').classList.remove('active');
    }

    function createRoom() {
      const name = document.getElementById('roomName').value.trim() || `${currentUser.displayName}'s Room`;
      const maxPlayers = parseInt(document.getElementById('maxPlayers').value);
      const turnTimeLimit = parseInt(document.getElementById('turnTimeLimit').value);

      ws.send(JSON.stringify({
        type: 'pesten:createRoom',
        name,
        maxPlayers,
        turnTimeLimit: turnTimeLimit > 0 ? turnTimeLimit : 9999 // 0 means no limit (use very high value)
      }));

      hideCreateModal();
    }

    function joinRoom(roomId) {
      ws.send(JSON.stringify({
        type: 'pesten:joinRoom',
        roomId
      }));
    }

    function leaveRoom() {
      clearTurnTimer();
      ws.send(JSON.stringify({
        type: 'pesten:leaveRoom',
        roomId: currentRoom?.id || gameState?.id
      }));
    }

    function addBot() {
      ws.send(JSON.stringify({
        type: 'pesten:addBot',
        roomId: currentRoom.id
      }));
    }

    function removeBot(botId) {
      ws.send(JSON.stringify({
        type: 'pesten:removeBot',
        roomId: currentRoom.id,
        botId
      }));
    }

    function startGame() {
      ws.send(JSON.stringify({
        type: 'pesten:startGame',
        roomId: currentRoom.id
      }));
    }

    // Hand sorting and reordering
    let currentSort = 'none';
    let customOrder = []; // Stores custom card order
    let draggedCard = null;

    const SUIT_ORDER = ['hearts', 'diamonds', 'clubs', 'spades', 'joker'];
    const RANK_ORDER = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A', 'joker'];

    function getDisplayHand(hand) {
      if (!hand || hand.length === 0) return [];

      // If we have a custom order, use it
      if (customOrder.length > 0 && currentSort === 'none') {
        const orderedHand = [];
        for (const cardId of customOrder) {
          const card = hand.find(c => c.id === cardId);
          if (card) orderedHand.push(card);
        }
        // Add any new cards not in custom order
        for (const card of hand) {
          if (!customOrder.includes(card.id)) {
            orderedHand.push(card);
          }
        }
        return orderedHand;
      }

      // Sort based on current sort mode
      const sortedHand = [...hand];

      if (currentSort === 'suit') {
        sortedHand.sort((a, b) => {
          const suitDiff = SUIT_ORDER.indexOf(a.suit) - SUIT_ORDER.indexOf(b.suit);
          if (suitDiff !== 0) return suitDiff;
          return RANK_ORDER.indexOf(a.rank) - RANK_ORDER.indexOf(b.rank);
        });
      } else if (currentSort === 'rank') {
        sortedHand.sort((a, b) => {
          const rankDiff = RANK_ORDER.indexOf(a.rank) - RANK_ORDER.indexOf(b.rank);
          if (rankDiff !== 0) return rankDiff;
          return SUIT_ORDER.indexOf(a.suit) - SUIT_ORDER.indexOf(b.suit);
        });
      }

      return sortedHand;
    }

    function sortHand(mode) {
      currentSort = mode;
      if (mode !== 'none') {
        customOrder = []; // Clear custom order when sorting
      }
      renderGame();
    }

    // Drag and drop handlers
    function handleDragStart(event) {
      draggedCard = event.target;
      draggedCard.classList.add('dragging');
      event.dataTransfer.effectAllowed = 'move';
      event.dataTransfer.setData('text/plain', event.target.dataset.cardId);
    }

    function handleDragOver(event) {
      event.preventDefault();
      event.dataTransfer.dropEffect = 'move';
    }

    function handleDragEnter(event) {
      event.preventDefault();
      const card = event.target.closest('.card');
      if (card && card !== draggedCard) {
        card.classList.add('drag-over');
      }
    }

    function handleDragLeave(event) {
      const card = event.target.closest('.card');
      if (card) {
        card.classList.remove('drag-over');
      }
    }

    function handleDrop(event) {
      event.preventDefault();
      const targetCard = event.target.closest('.card');

      if (targetCard && draggedCard && targetCard !== draggedCard) {
        const myPlayer = gameState.players.find(p => p.id === currentUser.id);
        if (!myPlayer?.hand) return;

        // Build current order
        const currentHand = getDisplayHand(myPlayer.hand);
        customOrder = currentHand.map(c => c.id);

        // Find indices
        const draggedId = draggedCard.dataset.cardId;
        const targetId = targetCard.dataset.cardId;
        const draggedIndex = customOrder.indexOf(draggedId);
        const targetIndex = customOrder.indexOf(targetId);

        if (draggedIndex > -1 && targetIndex > -1) {
          // Remove dragged card and insert at target position
          customOrder.splice(draggedIndex, 1);
          customOrder.splice(targetIndex, 0, draggedId);

          currentSort = 'none'; // Switch to custom order mode
          renderGame();
        }
      }

      if (targetCard) {
        targetCard.classList.remove('drag-over');
      }
    }

    function handleDragEnd(event) {
      if (draggedCard) {
        draggedCard.classList.remove('dragging');
      }
      draggedCard = null;

      // Clean up any remaining drag-over classes
      document.querySelectorAll('.card.drag-over').forEach(card => {
        card.classList.remove('drag-over');
      });
    }

    function playCard(cardId) {
      const myPlayer = gameState.players.find(p => p.id === currentUser.id);
      const card = myPlayer?.hand?.find(c => c.id === cardId);

      if (card && card.rank === 'J') {
        pendingJackCard = cardId;
        showSuitSelector();
        return;
      }

      // Animate card being played
      animateCardPlay(cardId);

      ws.send(JSON.stringify({
        type: 'pesten:playCard',
        roomId: gameState.id,
        cardId
      }));
    }

    function drawCard() {
      // Animate draw pile
      animateDrawPile();

      ws.send(JSON.stringify({
        type: 'pesten:drawCard',
        roomId: gameState.id
      }));
    }

    // Animation helper functions
    let lastHandCardIds = [];
    let lastTopCardId = null;
    let pendingAnimations = {
      newCards: [],
      discardLanding: false,
      turnChange: false,
      drawPile: false
    };

    function animateCardPlay(cardId) {
      const cardElement = document.querySelector(`[data-card-id="${cardId}"]`);
      if (cardElement) {
        cardElement.classList.add('playing');
      }
    }

    function animateDrawPile() {
      const drawPile = document.querySelector('.draw-pile');
      if (drawPile) {
        drawPile.classList.add('drawing');
        setTimeout(() => drawPile.classList.remove('drawing'), 200);
      }
    }

    function applyPendingAnimations() {
      // Use requestAnimationFrame to ensure DOM is rendered
      requestAnimationFrame(() => {
        // Apply new card animations
        if (pendingAnimations.newCards.length > 0) {
          pendingAnimations.newCards.forEach((cardId, index) => {
            setTimeout(() => {
              const cardElement = document.querySelector(`[data-card-id="${cardId}"]`);
              if (cardElement) {
                cardElement.classList.add('new-card');
                setTimeout(() => cardElement.classList.remove('new-card'), 500);
              }
            }, index * 150);
          });
        }

        // Apply discard pile animation
        if (pendingAnimations.discardLanding) {
          const discardPile = document.querySelector('.discard-pile');
          if (discardPile) {
            discardPile.classList.add('card-landing');
            setTimeout(() => discardPile.classList.remove('card-landing'), 400);
          }
        }

        // Apply turn change animation
        if (pendingAnimations.turnChange) {
          const turnIndicator = document.querySelector('.turn-indicator');
          if (turnIndicator) {
            turnIndicator.classList.add('your-turn-flash');
            setTimeout(() => turnIndicator.classList.remove('your-turn-flash'), 600);
          }
        }

        // Apply draw pile animation
        if (pendingAnimations.drawPile) {
          animateDrawPile();
        }

        // Reset pending animations
        pendingAnimations = {
          newCards: [],
          discardLanding: false,
          turnChange: false,
          drawPile: false
        };
      });
    }

    function detectAnimations(newState) {
      if (!newState || newState.gameState !== 'playing') return;

      const myPlayer = newState.players.find(p => p.id === currentUser.id);
      if (!myPlayer?.hand) return;

      const newCardIds = myPlayer.hand.map(c => c.id);
      const newTopCard = newState.topCard;

      // Check for new cards in hand (drawn cards)
      const addedCards = newCardIds.filter(id => !lastHandCardIds.includes(id));
      if (addedCards.length > 0 && lastHandCardIds.length > 0) {
        pendingAnimations.newCards = addedCards;
      }

      // Check for new top card (card was played)
      if (newTopCard && newTopCard.id !== lastTopCardId && lastTopCardId !== null) {
        pendingAnimations.discardLanding = true;
      }

      // Check for turn change to me
      const wasMyTurn = gameState?.players?.find(p => p.id === currentUser.id)?.isCurrentTurn;
      const isMyTurn = myPlayer.isCurrentTurn;
      if (isMyTurn && !wasMyTurn) {
        pendingAnimations.turnChange = true;
      }

      // Update tracking
      lastHandCardIds = newCardIds;
      lastTopCardId = newTopCard?.id || null;
    }

    function initAnimationState(state) {
      if (!state) {
        lastHandCardIds = [];
        lastTopCardId = null;
        return;
      }

      const myPlayer = state.players?.find(p => p.id === currentUser.id);
      if (myPlayer?.hand) {
        lastHandCardIds = myPlayer.hand.map(c => c.id);
      } else {
        lastHandCardIds = [];
      }
      lastTopCardId = state.topCard?.id || null;
    }

    function showSuitSelector() {
      document.getElementById('suitModal').classList.add('active');
    }

    function selectSuit(suit) {
      document.getElementById('suitModal').classList.remove('active');

      ws.send(JSON.stringify({
        type: 'pesten:playCard',
        roomId: gameState.id,
        cardId: pendingJackCard,
        chosenSuit: suit
      }));

      pendingJackCard = null;
    }

    function showWinnerModal() {
      setTimeout(() => {
        document.getElementById('winnerModal')?.classList.add('active');
      }, 500);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // User dropdown toggle
    function toggleUserDropdown(event) {
      event.stopPropagation();
      const userProfiles = document.querySelectorAll('.user-profile');
      userProfiles.forEach(profile => {
        if (event.currentTarget === profile) {
          profile.classList.toggle('open');
        } else {
          profile.classList.remove('open');
        }
      });
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const userProfiles = document.querySelectorAll('.user-profile');
      userProfiles.forEach(profile => {
        if (!profile.contains(e.target)) {
          profile.classList.remove('open');
        }
      });
    });

    // Initialize on load
    init();
  </script>
</body>
</html>
