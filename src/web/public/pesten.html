<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pesten - Card Game</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      background-attachment: fixed;
      color: #fff;
      overflow-x: hidden;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      margin-bottom: 30px;
      border-bottom: 2px solid rgba(255,255,255,0.1);
      position: relative;
      z-index: 100;
    }

    .logo {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, #e94560, #ff6b6b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 30px rgba(233, 69, 96, 0.5);
    }

    /* User Profile Dropdown */
    .user-profile {
      position: relative;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 12px 6px 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 24px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .user-profile:hover {
      background: rgba(255,255,255,0.15);
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #e94560;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      overflow: hidden;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .user-info {
      display: flex;
      flex-direction: column;
    }

    .user-label {
      font-size: 10px;
      color: rgba(255,255,255,0.5);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .user-name {
      font-size: 13px;
      font-weight: 600;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .user-name::after {
      content: '‚ñº';
      font-size: 8px;
      color: rgba(255,255,255,0.5);
      transition: transform 0.2s;
    }

    .user-profile.open .user-name::after {
      transform: rotate(180deg);
    }

    .user-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: #1a1a2e;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 8px;
      min-width: 180px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.2s;
      z-index: 2000;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .user-profile.open .user-dropdown {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .user-profile.open::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1999;
      background: transparent;
    }

    .user-dropdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      color: rgba(255,255,255,0.7);
      font-size: 14px;
      text-decoration: none;
      transition: all 0.2s;
    }

    .user-dropdown-item:hover {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }

    .user-dropdown-item.logout {
      color: #ef4444;
    }

    .user-dropdown-item.logout:hover {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }

    .user-dropdown-item.active {
      background: rgba(233, 69, 96, 0.2);
      color: #e94560;
    }

    .back-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      color: #fff;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
      transition: all 0.3s ease;
      text-decoration: none;
    }

    .back-btn:hover {
      background: rgba(255,255,255,0.2);
    }

    /* Lobby */
    .lobby {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 30px;
    }

    .main-panel {
      background: rgba(255,255,255,0.05);
      border-radius: 20px;
      padding: 30px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .panel-title {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .btn {
      background: linear-gradient(135deg, #e94560, #ff6b6b);
      border: none;
      color: #fff;
      padding: 12px 25px;
      border-radius: 25px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s ease;
      box-shadow: 0 5px 20px rgba(233, 69, 96, 0.4);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(233, 69, 96, 0.6);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: rgba(255,255,255,0.1);
      box-shadow: none;
    }

    .btn-secondary:hover {
      background: rgba(255,255,255,0.2);
      box-shadow: none;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 0.9rem;
    }

    /* Room List */
    .room-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .room-card {
      background: rgba(255,255,255,0.08);
      border-radius: 15px;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .room-card:hover {
      background: rgba(255,255,255,0.12);
      transform: translateX(5px);
    }

    .room-info h3 {
      font-size: 1.1rem;
      margin-bottom: 5px;
    }

    .room-info p {
      color: rgba(255,255,255,0.6);
      font-size: 0.9rem;
    }

    .room-players {
      display: flex;
      gap: 5px;
      margin-top: 10px;
    }

    .room-player-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: linear-gradient(135deg, #e94560, #ff6b6b);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .room-player-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .no-rooms {
      text-align: center;
      padding: 50px;
      color: rgba(255,255,255,0.5);
    }

    /* Sidebar Leaderboard */
    .sidebar {
      background: rgba(255,255,255,0.05);
      border-radius: 20px;
      padding: 25px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      height: fit-content;
    }

    .sidebar-title {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .leaderboard-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .leaderboard-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
    }

    .leaderboard-rank {
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, #e94560, #ff6b6b);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.85rem;
      flex-shrink: 0;
    }

    .leaderboard-rank.gold { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #000; }
    .leaderboard-rank.silver { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #000; }
    .leaderboard-rank.bronze { background: linear-gradient(135deg, #cd7f32, #a0522d); }

    .leaderboard-info {
      flex: 1;
      min-width: 0;
    }

    .leaderboard-name {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .streak-badge {
      font-size: 0.9rem;
    }

    .leaderboard-stats {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
      margin-top: 2px;
    }

    .leaderboard-stats .stat-highlight {
      color: #e94560;
      font-weight: 600;
    }

    .leaderboard-score {
      text-align: right;
      flex-shrink: 0;
    }

    .leaderboard-wins {
      font-weight: 700;
      color: #e94560;
      font-size: 1rem;
    }

    .leaderboard-games {
      font-size: 0.7rem;
      color: rgba(255,255,255,0.5);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      border-radius: 20px;
      padding: 30px;
      width: 90%;
      max-width: 450px;
      border: 1px solid rgba(255,255,255,0.1);
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal {
      transform: scale(1);
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 25px;
      text-align: center;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 12px 18px;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      color: #fff;
      font-family: inherit;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #e94560;
    }

    .modal-buttons {
      display: flex;
      gap: 15px;
      margin-top: 25px;
    }

    .modal-buttons .btn {
      flex: 1;
    }

    /* Game Room Lobby */
    .room-lobby {
      display: none;
    }

    .room-lobby.active {
      display: block;
    }

    .room-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid rgba(255,255,255,0.1);
    }

    .room-title {
      font-size: 1.8rem;
      font-weight: 700;
    }

    .room-actions {
      display: flex;
      gap: 15px;
    }

    .players-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .player-slot {
      background: rgba(255,255,255,0.08);
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      border: 2px solid rgba(255,255,255,0.1);
      transition: all 0.3s ease;
    }

    .player-slot.host {
      border-color: #ffd700;
    }

    .player-slot.empty {
      border-style: dashed;
      opacity: 0.5;
    }

    .player-slot-avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      margin: 0 auto 15px;
      background: linear-gradient(135deg, #e94560, #ff6b6b);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
    }

    .player-slot-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .player-slot-name {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 5px;
    }

    .player-slot-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .player-slot-badge.host-badge {
      background: linear-gradient(135deg, #ffd700, #ffaa00);
      color: #000;
    }

    .player-slot-badge.bot-badge {
      background: rgba(255,255,255,0.2);
    }

    .remove-bot-btn {
      margin-top: 10px;
      padding: 5px 15px;
      font-size: 0.8rem;
      background: rgba(255,0,0,0.3);
      border: none;
      color: #fff;
      border-radius: 15px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .remove-bot-btn:hover {
      background: rgba(255,0,0,0.5);
    }

    /* Game View */
    .game-view {
      display: none;
    }

    .game-view.active {
      display: block;
    }

    .game-container {
      display: grid;
      grid-template-columns: 1fr 280px;
      gap: 20px;
      height: calc(100vh - 150px);
    }

    .game-area {
      background: rgba(255,255,255,0.05);
      border-radius: 20px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      border: 1px solid rgba(255,255,255,0.1);
    }

    /* Other Players */
    .other-players {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .other-player {
      text-align: center;
      opacity: 0.7;
      transition: all 0.3s ease;
    }

    .other-player.current-turn {
      opacity: 1;
      transform: scale(1.1);
    }

    .other-player-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      margin: 0 auto 8px;
      background: linear-gradient(135deg, #e94560, #ff6b6b);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      border: 3px solid transparent;
      transition: border-color 0.3s ease;
    }

    .other-player.current-turn .other-player-avatar {
      border-color: #00ff88;
      box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
    }

    .other-player-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .other-player-name {
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .other-player-cards {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.6);
    }

    /* Table Area */
    .table-area {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 40px;
    }

    .draw-pile, .discard-pile {
      position: relative;
    }

    .pile-label {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.85rem;
      color: rgba(255,255,255,0.6);
      white-space: nowrap;
    }

    .draw-pile .card {
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .draw-pile .card:hover {
      transform: translateY(-5px);
    }

    .draw-pile .card.disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }

    /* Game Info */
    .game-info {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .info-item {
      background: rgba(255,255,255,0.1);
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 0.9rem;
    }

    .info-item strong {
      color: #e94560;
    }

    .pending-draws {
      background: linear-gradient(135deg, #ff4444, #cc0000) !important;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* Your Hand */
    .your-hand {
      background: rgba(0,0,0,0.3);
      border-radius: 20px;
      padding: 20px;
      margin-top: auto;
    }

    .hand-label {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.6);
      margin-bottom: 15px;
      text-align: center;
    }

    .hand-cards {
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
      min-height: 120px;
    }

    .hand-cards .card {
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .hand-cards .card:hover:not(.disabled) {
      transform: translateY(-15px);
    }

    .hand-cards .card.disabled {
      cursor: not-allowed;
      filter: brightness(0.5);
    }

    .hand-cards .card.playable {
      box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
    }

    /* Cards */
    .card {
      width: 70px;
      height: 100px;
      border-radius: 8px;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 700;
      position: relative;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .card.back {
      background: linear-gradient(135deg, #e94560, #ff6b6b);
      background-image: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 10px,
        rgba(255,255,255,0.1) 10px,
        rgba(255,255,255,0.1) 20px
      );
    }

    .card.hearts, .card.diamonds { color: #e94560; }
    .card.clubs, .card.spades { color: #1a1a2e; }
    .card.joker {
      background: linear-gradient(135deg, #ffd700, #ff6b6b, #00ff88, #00bfff);
      color: #fff;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }

    .card-rank {
      position: absolute;
      top: 5px;
      left: 8px;
      font-size: 0.9rem;
    }

    .card-suit {
      font-size: 2rem;
    }

    .card-rank-bottom {
      position: absolute;
      bottom: 5px;
      right: 8px;
      font-size: 0.9rem;
      transform: rotate(180deg);
    }

    /* Suit Selector Modal */
    .suit-selector {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .suit-option {
      padding: 25px;
      border-radius: 15px;
      background: rgba(255,255,255,0.1);
      border: 2px solid transparent;
      cursor: pointer;
      font-size: 3rem;
      text-align: center;
      transition: all 0.3s ease;
    }

    .suit-option:hover {
      background: rgba(255,255,255,0.2);
      border-color: #e94560;
    }

    .suit-option.hearts, .suit-option.diamonds { color: #e94560; }
    .suit-option.clubs, .suit-option.spades { color: #fff; }

    /* Game Sidebar */
    .game-sidebar {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .game-log {
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      padding: 15px;
      flex: 1;
      overflow-y: auto;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .log-title {
      font-weight: 600;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .log-messages {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 0.85rem;
    }

    .log-message {
      padding: 8px 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      color: rgba(255,255,255,0.8);
    }

    /* Turn indicator */
    .turn-indicator {
      background: linear-gradient(135deg, #00ff88, #00cc6a);
      color: #000;
      padding: 15px;
      border-radius: 15px;
      text-align: center;
      font-weight: 700;
      animation: glow 2s infinite;
    }

    .turn-indicator.waiting {
      background: rgba(255,255,255,0.1);
      color: #fff;
      animation: none;
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 20px rgba(0, 255, 136, 0.5); }
      50% { box-shadow: 0 0 30px rgba(0, 255, 136, 0.8); }
    }

    /* Winner Modal */
    .winner-content {
      text-align: center;
      padding: 20px;
    }

    .winner-trophy {
      font-size: 5rem;
      margin-bottom: 20px;
      animation: bounce 1s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }

    .winner-name {
      font-size: 2rem;
      font-weight: 700;
      color: #ffd700;
      margin-bottom: 10px;
    }

    /* Rules Info */
    .rules-info {
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      padding: 15px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .rules-title {
      font-weight: 600;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .rules-list {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.7);
    }

    .rules-list div {
      margin-bottom: 5px;
    }

    .rules-list strong {
      color: #e94560;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .lobby {
        grid-template-columns: 1fr;
      }

      .game-container {
        grid-template-columns: 1fr;
        height: auto;
      }

      .game-sidebar {
        order: -1;
      }

      .card {
        width: 55px;
        height: 80px;
        font-size: 1.2rem;
      }

      .card-rank { font-size: 0.7rem; }
      .card-suit { font-size: 1.5rem; }
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-size: 1.5rem;
    }

    .loading::after {
      content: '';
      width: 30px;
      height: 30px;
      border: 3px solid rgba(255,255,255,0.2);
      border-top-color: #e94560;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 15px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Hidden */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- SVG Icons -->
  <svg style="display:none;">
    <symbol id="icon-stats" viewBox="0 0 24 24">
      <path fill="currentColor" d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/>
    </symbol>
    <symbol id="icon-pictionary" viewBox="0 0 24 24">
      <path fill="currentColor" d="M18 4V3c0-.55-.45-1-1-1H5c-.55 0-1 .45-1 1v4c0 .55.45 1 1 1h12c.55 0 1-.45 1-1V6h1v4H9v11c0 .55.45 1 1 1h2c.55 0 1-.45 1-1v-9h8V4h-3z"/>
    </symbol>
    <symbol id="icon-hitster" viewBox="0 0 24 24">
      <path fill="currentColor" d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
    </symbol>
    <symbol id="icon-pesten" viewBox="0 0 24 24">
      <path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14l-5-5 1.41-1.41L12 14.17l4.59-4.58L18 11l-6 6z"/>
    </symbol>
    <symbol id="icon-music" viewBox="0 0 24 24">
      <path fill="currentColor" d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
    </symbol>
  </svg>

  <div id="app" class="loading">Loading...</div>

  <script>
    const SUITS = ['hearts', 'diamonds', 'clubs', 'spades'];
    const SUIT_SYMBOLS = {
      hearts: '‚ô•',
      diamonds: '‚ô¶',
      clubs: '‚ô£',
      spades: '‚ô†',
      joker: 'üÉè'
    };

    let ws = null;
    let currentUser = null;
    let currentRoom = null;
    let gameState = null;
    let pendingJackCard = null;

    // Initialize
    async function init() {
      try {
        const response = await fetch('/api/me');
        if (!response.ok) {
          window.location.href = '/login';
          return;
        }
        const userData = await response.json();
        // Transform to expected format
        currentUser = {
          id: userData.id,
          displayName: userData.username,
          avatar: userData.avatar
            ? `https://cdn.discordapp.com/avatars/${userData.id}/${userData.avatar}.png`
            : `https://cdn.discordapp.com/embed/avatars/${parseInt(userData.id) % 5}.png`
        };
        connectWebSocket();
        renderLobby();
      } catch (error) {
        console.error('Init error:', error);
        window.location.href = '/login';
      }
    }

    // WebSocket connection
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}`);

      ws.onopen = () => {
        console.log('WebSocket connected');
        ws.send(JSON.stringify({ type: 'pesten:getRooms' }));
        ws.send(JSON.stringify({ type: 'pesten:getLeaderboard' }));

        // Try to rejoin room if we were in one
        const savedRoomId = sessionStorage.getItem('pestenRoomId');
        if (savedRoomId) {
          console.log('Attempting to rejoin room:', savedRoomId);
          ws.send(JSON.stringify({ type: 'pesten:rejoinRoom', roomId: savedRoomId }));
        }
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleMessage(data);
      };

      ws.onclose = () => {
        console.log('WebSocket disconnected, reconnecting...');
        setTimeout(connectWebSocket, 2000);
      };
    }

    function handleMessage(data) {
      switch (data.type) {
        case 'pesten:roomList':
          renderRoomList(data.rooms);
          break;
        case 'pesten:leaderboard':
          renderLeaderboard(data.leaderboard);
          break;
        case 'pesten:roomCreated':
        case 'pesten:roomJoined':
        case 'pesten:rejoined':
          currentRoom = data.room;
          sessionStorage.setItem('pestenRoomId', currentRoom.id);
          if (currentRoom.gameState === 'playing') {
            gameState = currentRoom;
            renderGame();
          } else if (currentRoom.gameState === 'finished') {
            gameState = currentRoom;
            renderGame();
            showWinnerModal();
          } else {
            renderRoomLobby();
          }
          break;
        case 'pesten:roomUpdated':
          currentRoom = data.room;
          if (currentRoom.gameState === 'playing') {
            gameState = currentRoom;
            renderGame();
          } else if (currentRoom.gameState === 'finished') {
            gameState = currentRoom;
            renderGame();
            showWinnerModal();
          } else {
            renderRoomLobby();
          }
          break;
        case 'pesten:gameState':
          gameState = data.state;
          renderGame();
          if (gameState.gameState === 'finished') {
            showWinnerModal();
          }
          break;
        case 'pesten:error':
          alert(data.message);
          break;
        case 'pesten:roomLeft':
          currentRoom = null;
          gameState = null;
          sessionStorage.removeItem('pestenRoomId');
          renderLobby();
          ws.send(JSON.stringify({ type: 'pesten:getRooms' }));
          break;
        case 'pesten:rejoinFailed':
          // Room no longer exists or player was removed
          sessionStorage.removeItem('pestenRoomId');
          renderLobby();
          break;
        case 'pesten:needsSuit':
          showSuitSelector();
          break;
      }
    }

    // Render functions
    function renderLobby() {
      document.getElementById('app').className = '';
      document.getElementById('app').innerHTML = `
        <div class="container">
          <div class="header">
            <div class="logo">üÉè Pesten</div>
            <div style="display: flex; gap: 15px; align-items: center;">
              <a href="/" class="back-btn">‚Üê Back</a>
              <div class="user-profile" onclick="toggleUserDropdown(event)">
                <div class="user-avatar">
                  <img src="${currentUser.avatar}" alt="Avatar">
                </div>
                <div class="user-info">
                  <span class="user-label">Logged in as</span>
                  <span class="user-name">${currentUser.displayName}</span>
                </div>
                <div class="user-dropdown">
                  <a href="/" class="user-dropdown-item">
                    <svg style="width:16px;height:16px;"><use href="#icon-music"/></svg>
                    Music Player
                  </a>
                  <a href="/stats" class="user-dropdown-item">
                    <svg style="width:16px;height:16px;"><use href="#icon-stats"/></svg>
                    Listening Stats
                  </a>
                  <a href="/pictionary" class="user-dropdown-item">
                    <svg style="width:16px;height:16px;"><use href="#icon-pictionary"/></svg>
                    Pictionary Game
                  </a>
                  <a href="/hitster" class="user-dropdown-item">
                    <svg style="width:16px;height:16px;"><use href="#icon-hitster"/></svg>
                    Hitster Music Game
                  </a>
                  <a href="/pesten" class="user-dropdown-item active">
                    <svg style="width:16px;height:16px;"><use href="#icon-pesten"/></svg>
                    Pesten Card Game
                  </a>
                  <a href="/logout" class="user-dropdown-item logout">
                    üö™ Logout
                  </a>
                </div>
              </div>
            </div>
          </div>

          <div class="lobby">
            <div class="main-panel">
              <div class="panel-header">
                <h2 class="panel-title">Game Rooms</h2>
                <button class="btn" onclick="showCreateModal()">+ Create Room</button>
              </div>
              <div class="room-list" id="roomList">
                <div class="no-rooms">No rooms available. Create one!</div>
              </div>
            </div>

            <div class="sidebar">
              <h3 class="sidebar-title">üèÜ Leaderboard</h3>
              <div class="leaderboard-list" id="leaderboard">
                <div style="color: rgba(255,255,255,0.5); text-align: center;">Loading...</div>
              </div>

              <div class="rules-info" style="margin-top: 20px;">
                <div class="rules-title">üìú Special Cards</div>
                <div class="rules-list">
                  <div><strong>2</strong> - Next player draws 2 (stackable)</div>
                  <div><strong>7</strong> - Play again</div>
                  <div><strong>8</strong> - Skip next player</div>
                  <div><strong>J</strong> - Wild, choose suit</div>
                  <div><strong>A</strong> - Reverse direction</div>
                  <div><strong>üÉè</strong> - Next player draws 5 (stackable)</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-overlay" id="createModal">
          <div class="modal">
            <h3 class="modal-title">Create Room</h3>
            <div class="form-group">
              <label>Room Name</label>
              <input type="text" id="roomName" placeholder="Enter room name" maxlength="30">
            </div>
            <div class="form-group">
              <label>Max Players</label>
              <select id="maxPlayers">
                <option value="2">2 Players</option>
                <option value="3">3 Players</option>
                <option value="4" selected>4 Players</option>
                <option value="5">5 Players</option>
                <option value="6">6 Players</option>
              </select>
            </div>
            <div class="modal-buttons">
              <button class="btn btn-secondary" onclick="hideCreateModal()">Cancel</button>
              <button class="btn" onclick="createRoom()">Create</button>
            </div>
          </div>
        </div>
      `;
    }

    function renderRoomList(rooms) {
      const container = document.getElementById('roomList');
      if (!container) return;

      if (rooms.length === 0) {
        container.innerHTML = '<div class="no-rooms">No rooms available. Create one!</div>';
        return;
      }

      container.innerHTML = rooms.map(room => `
        <div class="room-card">
          <div class="room-info">
            <h3>${escapeHtml(room.name)}</h3>
            <p>${room.playerCount}/${room.maxPlayers} players</p>
            <div class="room-players">
              ${room.players.map(p => `
                <div class="room-player-avatar" title="${escapeHtml(p.name)}">
                  ${p.avatar ? `<img src="${p.avatar}" alt="">` : (p.isBot ? 'ü§ñ' : p.name[0])}
                </div>
              `).join('')}
            </div>
          </div>
          <button class="btn" onclick="joinRoom('${room.id}')" ${room.playerCount >= room.maxPlayers ? 'disabled' : ''}>
            Join
          </button>
        </div>
      `).join('');
    }

    function renderLeaderboard(leaderboard) {
      const container = document.getElementById('leaderboard');
      if (!container) return;

      if (leaderboard.length === 0) {
        container.innerHTML = '<div style="color: rgba(255,255,255,0.5); text-align: center;">No games played yet</div>';
        return;
      }

      container.innerHTML = leaderboard.map((player, index) => `
        <div class="leaderboard-item">
          <div class="leaderboard-rank ${index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : ''}">${index + 1}</div>
          <div class="leaderboard-info">
            <div class="leaderboard-name">
              ${escapeHtml(player.displayName)}
              ${player.winStreak >= 3 ? '<span class="streak-badge" title="On a winning streak!">üî•</span>' : ''}
            </div>
            <div class="leaderboard-stats">
              <span class="stat-highlight">${player.winRate}%</span> win rate ¬∑
              <span class="stat-highlight">${player.avgDrawsForced || 0}</span> avg draws forced
            </div>
          </div>
          <div class="leaderboard-score">
            <div class="leaderboard-wins">${player.gamesWon}W</div>
            <div class="leaderboard-games">${player.gamesPlayed} games</div>
          </div>
        </div>
      `).join('');
    }

    function renderRoomLobby() {
      document.getElementById('app').innerHTML = `
        <div class="container">
          <div class="header">
            <div class="logo">üÉè Pesten</div>
            <div class="user-profile" onclick="toggleUserDropdown(event)">
              <div class="user-avatar">
                <img src="${currentUser.avatar}" alt="Avatar">
              </div>
              <div class="user-info">
                <span class="user-label">Logged in as</span>
                <span class="user-name">${currentUser.displayName}</span>
              </div>
              <div class="user-dropdown">
                <a href="/" class="user-dropdown-item">
                  <svg style="width:16px;height:16px;"><use href="#icon-music"/></svg>
                  Music Player
                </a>
                <a href="/stats" class="user-dropdown-item">
                  <svg style="width:16px;height:16px;"><use href="#icon-stats"/></svg>
                  Listening Stats
                </a>
                <a href="/pictionary" class="user-dropdown-item">
                  <svg style="width:16px;height:16px;"><use href="#icon-pictionary"/></svg>
                  Pictionary Game
                </a>
                <a href="/hitster" class="user-dropdown-item">
                  <svg style="width:16px;height:16px;"><use href="#icon-hitster"/></svg>
                  Hitster Music Game
                </a>
                <a href="/pesten" class="user-dropdown-item active">
                  <svg style="width:16px;height:16px;"><use href="#icon-pesten"/></svg>
                  Pesten Card Game
                </a>
                <a href="/logout" class="user-dropdown-item logout">
                  üö™ Logout
                </a>
              </div>
            </div>
          </div>

          <div class="main-panel">
            <div class="room-header">
              <h2 class="room-title">${escapeHtml(currentRoom.name)}</h2>
              <div class="room-actions">
                ${currentRoom.hostId === currentUser.id ? `
                  <button class="btn btn-secondary" onclick="addBot()">+ Add Bot</button>
                  <button class="btn" onclick="startGame()" ${currentRoom.players.length < 2 ? 'disabled' : ''}>
                    Start Game
                  </button>
                ` : ''}
                <button class="btn btn-secondary" onclick="leaveRoom()">Leave</button>
              </div>
            </div>

            <div class="players-grid">
              ${currentRoom.players.map(player => `
                <div class="player-slot ${player.id === currentRoom.hostId ? 'host' : ''}">
                  <div class="player-slot-avatar">
                    ${player.avatar ? `<img src="${player.avatar}" alt="">` : (player.isBot ? 'ü§ñ' : player.name[0])}
                  </div>
                  <div class="player-slot-name">${escapeHtml(player.name)}</div>
                  ${player.id === currentRoom.hostId ? '<span class="player-slot-badge host-badge">Host</span>' : ''}
                  ${player.isBot ? '<span class="player-slot-badge bot-badge">Bot</span>' : ''}
                  ${player.isBot && currentRoom.hostId === currentUser.id ? `
                    <button class="remove-bot-btn" onclick="removeBot('${player.id}')">Remove</button>
                  ` : ''}
                </div>
              `).join('')}
              ${Array(currentRoom.maxPlayers - currentRoom.players.length).fill().map(() => `
                <div class="player-slot empty">
                  <div class="player-slot-avatar">?</div>
                  <div class="player-slot-name">Waiting...</div>
                </div>
              `).join('')}
            </div>

            <div class="rules-info">
              <div class="rules-title">üìú How to Play</div>
              <div class="rules-list">
                <div>Match the top card by <strong>suit</strong> or <strong>rank</strong></div>
                <div>Can't play? Click the deck to draw a card</div>
                <div>First player to empty their hand wins!</div>
                <div style="margin-top: 10px;"><strong>Special Cards:</strong> 2 (draw 2), 7 (play again), 8 (skip), J (wild), A (reverse), üÉè (draw 5)</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderGame() {
      if (!gameState) return;

      const myPlayer = gameState.players.find(p => p.id === currentUser.id);
      const otherPlayers = gameState.players.filter(p => p.id !== currentUser.id);
      const currentPlayer = gameState.players[gameState.currentPlayerIndex];
      const isMyTurn = currentPlayer.id === currentUser.id;

      document.getElementById('app').innerHTML = `
        <div class="container">
          <div class="header">
            <div class="logo">üÉè Pesten</div>
            <div style="display: flex; gap: 15px; align-items: center;">
              <button class="btn btn-secondary btn-small" onclick="leaveRoom()">Leave Game</button>
              <div class="user-profile" onclick="toggleUserDropdown(event)">
                <div class="user-avatar">
                  <img src="${currentUser.avatar}" alt="Avatar">
                </div>
                <div class="user-info">
                  <span class="user-label">Logged in as</span>
                  <span class="user-name">${currentUser.displayName}</span>
                </div>
                <div class="user-dropdown">
                  <a href="/" class="user-dropdown-item">
                    <svg style="width:16px;height:16px;"><use href="#icon-music"/></svg>
                    Music Player
                  </a>
                  <a href="/stats" class="user-dropdown-item">
                    <svg style="width:16px;height:16px;"><use href="#icon-stats"/></svg>
                    Listening Stats
                  </a>
                  <a href="/pictionary" class="user-dropdown-item">
                    <svg style="width:16px;height:16px;"><use href="#icon-pictionary"/></svg>
                    Pictionary Game
                  </a>
                  <a href="/hitster" class="user-dropdown-item">
                    <svg style="width:16px;height:16px;"><use href="#icon-hitster"/></svg>
                    Hitster Music Game
                  </a>
                  <a href="/pesten" class="user-dropdown-item active">
                    <svg style="width:16px;height:16px;"><use href="#icon-pesten"/></svg>
                    Pesten Card Game
                  </a>
                  <a href="/logout" class="user-dropdown-item logout">
                    üö™ Logout
                  </a>
                </div>
              </div>
            </div>
          </div>

          <div class="game-container">
            <div class="game-area">
              <!-- Other players -->
              <div class="other-players">
                ${otherPlayers.map(player => `
                  <div class="other-player ${player.isCurrentTurn ? 'current-turn' : ''}">
                    <div class="other-player-avatar">
                      ${player.avatar ? `<img src="${player.avatar}" alt="">` : (player.isBot ? 'ü§ñ' : player.name[0])}
                    </div>
                    <div class="other-player-name">${escapeHtml(player.name)}</div>
                    <div class="other-player-cards">${player.cardCount} cards</div>
                  </div>
                `).join('')}
              </div>

              <!-- Game info -->
              <div class="game-info">
                <div class="info-item">Direction: <strong>${gameState.direction === 1 ? '‚Üí Clockwise' : '‚Üê Counter'}</strong></div>
                ${gameState.chosenSuit ? `<div class="info-item">Chosen Suit: <strong>${SUIT_SYMBOLS[gameState.chosenSuit]}</strong></div>` : ''}
                ${gameState.pendingDraws > 0 ? `<div class="info-item pending-draws">‚ö†Ô∏è Draw ${gameState.pendingDraws} cards!</div>` : ''}
                <div class="info-item">Deck: <strong>${gameState.deckCount}</strong></div>
              </div>

              <!-- Table -->
              <div class="table-area">
                <div class="draw-pile">
                  <div class="pile-label">Draw Pile</div>
                  <div class="card back ${!isMyTurn || gameState.gameState === 'finished' ? 'disabled' : ''}"
                       onclick="${isMyTurn && gameState.gameState === 'playing' ? 'drawCard()' : ''}">
                  </div>
                </div>

                <div class="discard-pile">
                  <div class="pile-label">Discard Pile</div>
                  ${renderCard(gameState.topCard)}
                </div>
              </div>

              <!-- Your hand -->
              <div class="your-hand">
                <div class="hand-label">Your Hand (${myPlayer?.hand?.length || 0} cards)</div>
                <div class="hand-cards">
                  ${(myPlayer?.hand || []).map(card => {
                    const canPlay = isMyTurn && gameState.gameState === 'playing' && canPlayCard(card);
                    return `
                      <div class="card ${card.suit} ${!isMyTurn || gameState.gameState === 'finished' ? 'disabled' : ''} ${canPlay ? 'playable' : ''}"
                           onclick="${canPlay ? `playCard('${card.id}')` : ''}">
                        ${renderCardContent(card)}
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            </div>

            <!-- Sidebar -->
            <div class="game-sidebar">
              <div class="turn-indicator ${isMyTurn ? '' : 'waiting'}">
                ${gameState.gameState === 'finished'
                  ? `üéâ ${escapeHtml(gameState.winner.name)} wins!`
                  : (isMyTurn ? 'üéØ Your Turn!' : `Waiting for ${escapeHtml(currentPlayer.name)}...`)}
              </div>

              <div class="game-log">
                <div class="log-title">Game Log</div>
                <div class="log-messages">
                  ${gameState.gameLog.map(log => `
                    <div class="log-message">${escapeHtml(log.message)}</div>
                  `).join('')}
                </div>
              </div>

              <div class="rules-info">
                <div class="rules-title">üìú Quick Reference</div>
                <div class="rules-list">
                  <div><strong>2</strong> Draw 2 | <strong>7</strong> Play again</div>
                  <div><strong>8</strong> Skip | <strong>J</strong> Wild</div>
                  <div><strong>A</strong> Reverse | <strong>üÉè</strong> Draw 5</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-overlay" id="suitModal">
          <div class="modal">
            <h3 class="modal-title">Choose a Suit</h3>
            <div class="suit-selector">
              <div class="suit-option hearts" onclick="selectSuit('hearts')">‚ô•</div>
              <div class="suit-option diamonds" onclick="selectSuit('diamonds')">‚ô¶</div>
              <div class="suit-option clubs" onclick="selectSuit('clubs')">‚ô£</div>
              <div class="suit-option spades" onclick="selectSuit('spades')">‚ô†</div>
            </div>
          </div>
        </div>

        <div class="modal-overlay" id="winnerModal">
          <div class="modal">
            <div class="winner-content">
              <div class="winner-trophy">üèÜ</div>
              <div class="winner-name">${gameState.winner ? escapeHtml(gameState.winner.name) : ''}</div>
              <div>wins the game!</div>
              <div class="modal-buttons" style="margin-top: 30px;">
                <button class="btn" onclick="leaveRoom()">Back to Lobby</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderCard(card) {
      if (!card) return '<div class="card back"></div>';
      return `
        <div class="card ${card.suit}">
          ${renderCardContent(card)}
        </div>
      `;
    }

    function renderCardContent(card) {
      if (card.suit === 'joker') {
        return '<div class="card-suit">üÉè</div>';
      }
      return `
        <div class="card-rank">${card.rank}</div>
        <div class="card-suit">${SUIT_SYMBOLS[card.suit]}</div>
        <div class="card-rank-bottom">${card.rank}</div>
      `;
    }

    function canPlayCard(card) {
      if (!gameState || gameState.gameState !== 'playing') return false;

      const topCard = gameState.topCard;
      const pendingDraws = gameState.pendingDraws;
      const chosenSuit = gameState.chosenSuit;

      // If there are pending draws, only matching draw cards can be played
      if (pendingDraws > 0) {
        if (topCard.rank === '2' || topCard.suit === 'joker') {
          if (topCard.rank === '2' && card.rank === '2') return true;
          if (card.suit === 'joker') return true;
          if (topCard.suit === 'joker' && card.rank === '2') return true;
          return false;
        }
      }

      // Joker can always be played
      if (card.suit === 'joker') return true;

      // Jack (wild) can always be played
      if (card.rank === 'J') return true;

      // If a suit was chosen (after Jack), must match that suit
      if (chosenSuit) {
        return card.suit === chosenSuit || card.rank === 'J';
      }

      // Match by suit or rank
      return card.suit === topCard.suit || card.rank === topCard.rank;
    }

    // Actions
    function showCreateModal() {
      document.getElementById('createModal').classList.add('active');
      document.getElementById('roomName').focus();
    }

    function hideCreateModal() {
      document.getElementById('createModal').classList.remove('active');
    }

    function createRoom() {
      const name = document.getElementById('roomName').value.trim() || `${currentUser.displayName}'s Room`;
      const maxPlayers = parseInt(document.getElementById('maxPlayers').value);

      ws.send(JSON.stringify({
        type: 'pesten:createRoom',
        name,
        maxPlayers
      }));

      hideCreateModal();
    }

    function joinRoom(roomId) {
      ws.send(JSON.stringify({
        type: 'pesten:joinRoom',
        roomId
      }));
    }

    function leaveRoom() {
      ws.send(JSON.stringify({
        type: 'pesten:leaveRoom',
        roomId: currentRoom?.id || gameState?.id
      }));
    }

    function addBot() {
      ws.send(JSON.stringify({
        type: 'pesten:addBot',
        roomId: currentRoom.id
      }));
    }

    function removeBot(botId) {
      ws.send(JSON.stringify({
        type: 'pesten:removeBot',
        roomId: currentRoom.id,
        botId
      }));
    }

    function startGame() {
      ws.send(JSON.stringify({
        type: 'pesten:startGame',
        roomId: currentRoom.id
      }));
    }

    function playCard(cardId) {
      const myPlayer = gameState.players.find(p => p.id === currentUser.id);
      const card = myPlayer?.hand?.find(c => c.id === cardId);

      if (card && card.rank === 'J') {
        pendingJackCard = cardId;
        showSuitSelector();
        return;
      }

      ws.send(JSON.stringify({
        type: 'pesten:playCard',
        roomId: gameState.id,
        cardId
      }));
    }

    function drawCard() {
      ws.send(JSON.stringify({
        type: 'pesten:drawCard',
        roomId: gameState.id
      }));
    }

    function showSuitSelector() {
      document.getElementById('suitModal').classList.add('active');
    }

    function selectSuit(suit) {
      document.getElementById('suitModal').classList.remove('active');

      ws.send(JSON.stringify({
        type: 'pesten:playCard',
        roomId: gameState.id,
        cardId: pendingJackCard,
        chosenSuit: suit
      }));

      pendingJackCard = null;
    }

    function showWinnerModal() {
      setTimeout(() => {
        document.getElementById('winnerModal')?.classList.add('active');
      }, 500);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // User dropdown toggle
    function toggleUserDropdown(event) {
      event.stopPropagation();
      const userProfiles = document.querySelectorAll('.user-profile');
      userProfiles.forEach(profile => {
        if (event.currentTarget === profile) {
          profile.classList.toggle('open');
        } else {
          profile.classList.remove('open');
        }
      });
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const userProfiles = document.querySelectorAll('.user-profile');
      userProfiles.forEach(profile => {
        if (!profile.contains(e.target)) {
          profile.classList.remove('open');
        }
      });
    });

    // Initialize on load
    init();
  </script>
</body>
</html>
