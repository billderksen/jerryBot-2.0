<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Listening Stats - Godcord Music Bot</title>
  <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
  <style>
    :root {
      --bg-primary: #0a0a0a;
      --bg-secondary: #111111;
      --bg-tertiary: #1a1a1a;
      --bg-hover: #222222;
      --surface: #161616;
      --border: #2a2a2a;
      --text-primary: #ffffff;
      --text-secondary: #a0a0a0;
      --text-muted: #666666;
      --accent: #1db954;
      --accent-hover: #1ed760;
      --accent-dim: rgba(29, 185, 84, 0.1);
      --gold: #ffd700;
      --silver: #c0c0c0;
      --bronze: #cd7f32;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      text-decoration: none;
      font-size: 14px;
      transition: all 0.2s;
    }

    .back-btn:hover {
      background: var(--bg-hover);
      border-color: var(--accent);
    }

    .back-btn svg {
      width: 18px;
      height: 18px;
    }

    h1 {
      font-size: 28px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    h1 svg {
      width: 32px;
      height: 32px;
      color: var(--accent);
    }

    .stats-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .sections {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    @media (max-width: 900px) {
      .sections {
        grid-template-columns: 1fr;
      }
    }

    .section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .section-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .section-header h2 {
      font-size: 18px;
      font-weight: 600;
    }

    .section-header svg {
      width: 22px;
      height: 22px;
      color: var(--accent);
    }

    .list {
      max-height: 500px;
      overflow-y: auto;
    }

    .list-item {
      display: flex;
      align-items: center;
      padding: 14px 24px;
      border-bottom: 1px solid var(--border);
      gap: 16px;
      transition: background 0.2s;
    }

    .list-item.clickable {
      cursor: pointer;
    }

    .list-item.clickable:hover {
      background: var(--bg-hover);
    }

    .list-item.clickable:active {
      background: var(--bg-tertiary);
    }

    .list-item:last-child {
      border-bottom: none;
    }

    .list-item:hover {
      background: var(--bg-hover);
    }

    .rank {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      border-radius: 50%;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      flex-shrink: 0;
    }

    .rank.gold {
      background: linear-gradient(135deg, #ffd700, #ffed4a);
      color: #000;
    }

    .rank.silver {
      background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
      color: #000;
    }

    .rank.bronze {
      background: linear-gradient(135deg, #cd7f32, #daa06d);
      color: #000;
    }

    .user-info, .song-info {
      flex: 1;
      min-width: 0;
    }

    .user-name, .song-title {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-stats, .song-stats {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .song-playtime {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .song-thumbnail {
      width: 48px;
      height: 48px;
      border-radius: 6px;
      background: var(--bg-tertiary);
      overflow: hidden;
      flex-shrink: 0;
    }

    .song-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .play-count {
      font-weight: 600;
      color: var(--accent);
      white-space: nowrap;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px;
      color: var(--text-secondary);
    }

    .empty-state {
      text-align: center;
      padding: 60px 24px;
      color: var(--text-muted);
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Custom scrollbar */
    .list::-webkit-scrollbar {
      width: 8px;
    }

    .list::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    .list::-webkit-scrollbar-thumb {
      background: var(--bg-tertiary);
      border-radius: 4px;
    }

    .list::-webkit-scrollbar-thumb:hover {
      background: var(--border);
    }

    /* User avatar */
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
      color: var(--text-secondary);
    }

    /* Toast notifications */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 1000;
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast-success {
      background: var(--accent);
      color: #000;
    }

    .toast-error {
      background: #e74c3c;
      color: #fff;
    }

    .toast-info {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }
  </style>
</head>
<body>
  <!-- SVG Icons -->
  <svg style="display: none;">
    <symbol id="icon-arrow-left" viewBox="0 0 24 24">
      <path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
    </symbol>
    <symbol id="icon-chart" viewBox="0 0 24 24">
      <path fill="currentColor" d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/>
    </symbol>
    <symbol id="icon-users" viewBox="0 0 24 24">
      <path fill="currentColor" d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
    </symbol>
    <symbol id="icon-music" viewBox="0 0 24 24">
      <path fill="currentColor" d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
    </symbol>
    <symbol id="icon-clock" viewBox="0 0 24 24">
      <path fill="currentColor" d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
    </symbol>
    <symbol id="icon-trophy" viewBox="0 0 24 24">
      <path fill="currentColor" d="M19 5h-2V3H7v2H5c-1.1 0-2 .9-2 2v1c0 2.55 1.92 4.63 4.39 4.94.63 1.5 1.98 2.63 3.61 2.96V19H7v2h10v-2h-4v-3.1c1.63-.33 2.98-1.46 3.61-2.96C19.08 12.63 21 10.55 21 8V7c0-1.1-.9-2-2-2zM5 8V7h2v3.82C5.84 10.4 5 9.3 5 8zm14 0c0 1.3-.84 2.4-2 2.82V7h2v1z"/>
    </symbol>
  </svg>

  <div class="container">
    <div class="header">
      <div class="header-left">
        <a href="/" class="back-btn">
          <svg><use href="#icon-arrow-left"/></svg>
          Back to Player
        </a>
        <h1>
          <svg><use href="#icon-chart"/></svg>
          Listening Stats
        </h1>
      </div>
    </div>

    <div class="stats-overview" id="statsOverview">
      <div class="stat-card">
        <div class="stat-value" id="totalSongs">-</div>
        <div class="stat-label">Songs Played</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalTime">-</div>
        <div class="stat-label">Total Listening Time</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="uniqueUsers">-</div>
        <div class="stat-label">Unique Listeners</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="uniqueSongs">-</div>
        <div class="stat-label">Unique Songs</div>
      </div>
    </div>

    <div class="sections">
      <div class="section">
        <div class="section-header">
          <svg><use href="#icon-trophy"/></svg>
          <h2>Top Listeners</h2>
        </div>
        <div class="list" id="topUsersList">
          <div class="loading">Loading...</div>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <svg><use href="#icon-music"/></svg>
          <h2>Most Played Songs</h2>
        </div>
        <div class="list" id="topSongsList">
          <div class="loading">Loading...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Format duration from seconds to readable string
    function formatDuration(seconds) {
      if (!seconds || seconds < 0) return '0m';
      
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      
      if (hours > 0) {
        return `${hours}h ${minutes}m`;
      }
      return `${minutes}m`;
    }

    // Format large numbers
    function formatNumber(num) {
      if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
      }
      if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
      }
      return num.toString();
    }

    // Get rank class for styling
    function getRankClass(index) {
      if (index === 0) return 'gold';
      if (index === 1) return 'silver';
      if (index === 2) return 'bronze';
      return '';
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Render top users list
    function renderTopUsers(users) {
      const list = document.getElementById('topUsersList');
      
      if (!users || users.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <svg><use href="#icon-users"/></svg>
            <div>No listening data yet</div>
          </div>
        `;
        return;
      }

      list.innerHTML = users.map((user, index) => `
        <div class="list-item">
          <div class="rank ${getRankClass(index)}">${index + 1}</div>
          <div class="user-avatar">ðŸ‘¤</div>
          <div class="user-info">
            <div class="user-name">${escapeHtml(user.displayName)}</div>
            <div class="user-stats">
              ${user.songsPlayed} songs queued
            </div>
          </div>
          <div class="play-count">${formatDuration(user.totalListeningTime)}</div>
        </div>
      `).join('');
    }

    // Get top requester for a song
    function getTopRequester(song) {
      if (!song.requestedBy || Object.keys(song.requestedBy).length === 0) {
        return null;
      }
      
      let topUser = null;
      let topCount = 0;
      
      for (const [userId, data] of Object.entries(song.requestedBy)) {
        if (data.count > topCount) {
          topCount = data.count;
          topUser = data.displayName;
        }
      }
      
      return topUser;
    }

    // Render top songs list
    function renderTopSongs(songs) {
      const list = document.getElementById('topSongsList');
      
      if (!songs || songs.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <svg><use href="#icon-music"/></svg>
            <div>No songs played yet</div>
          </div>
        `;
        return;
      }

      list.innerHTML = songs.map((song, index) => {
        const topRequester = getTopRequester(song);
        return `
          <div class="list-item clickable" data-url="${escapeHtml(song.url)}" data-title="${escapeHtml(song.title)}" data-thumbnail="${escapeHtml(song.thumbnail || '')}" data-duration="${song.duration || 0}" onclick="addSongToQueue(this)">
            <div class="rank ${getRankClass(index)}">${index + 1}</div>
            <div class="song-thumbnail">
              ${song.thumbnail 
                ? `<img src="${song.thumbnail}" alt="" onerror="this.parentElement.innerHTML='ðŸŽµ'">`
                : 'ðŸŽµ'
              }
            </div>
            <div class="song-info">
              <div class="song-title" title="${escapeHtml(song.title)}">${escapeHtml(song.title)}</div>
              <div class="song-playtime">${formatDuration(song.totalListeningTime || 0)} played${topRequester ? ` Â· Most requested by ${escapeHtml(topRequester)}` : ''}</div>
            </div>
            <div class="play-count">${song.playCount}Ã—</div>
          </div>
        `;
      }).join('');
    }

    // Load stats from API
    async function loadStats() {
      try {
        const response = await fetch('/api/stats');
        const data = await response.json();

        // Update overview cards
        document.getElementById('totalSongs').textContent = formatNumber(data.totalSongsPlayed);
        document.getElementById('totalTime').textContent = formatDuration(data.totalListeningTime);
        document.getElementById('uniqueUsers').textContent = formatNumber(data.uniqueUsers);
        document.getElementById('uniqueSongs').textContent = formatNumber(data.uniqueSongs);

        // Render lists
        renderTopUsers(data.topUsers);
        renderTopSongs(data.topSongs);
      } catch (error) {
        console.error('Error loading stats:', error);
        document.getElementById('topUsersList').innerHTML = `
          <div class="empty-state">
            <div>Failed to load stats</div>
          </div>
        `;
        document.getElementById('topSongsList').innerHTML = `
          <div class="empty-state">
            <div>Failed to load stats</div>
          </div>
        `;
      }
    }

    // Add song to queue when clicked
    async function addSongToQueue(element) {
      const url = element.dataset.url;
      const title = element.dataset.title;
      const thumbnail = element.dataset.thumbnail;
      const duration = parseInt(element.dataset.duration) || 0;
      
      if (!url) {
        showToast('Cannot add song: URL not available', 'error');
        return;
      }
      
      // Disable the element while adding
      element.style.opacity = '0.5';
      element.style.pointerEvents = 'none';
      
      // Show immediate feedback
      showToast(`Adding "${title}"...`, 'info');
      
      try {
        const response = await fetch('/api/queue/add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ url, title, thumbnail, duration })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showToast(`Added "${title}" to queue`, 'success');
        } else {
          showToast(data.error || 'Failed to add song', 'error');
        }
      } catch (error) {
        console.error('Error adding song:', error);
        showToast('Failed to add song to queue', 'error');
      } finally {
        // Re-enable the element
        element.style.opacity = '1';
        element.style.pointerEvents = 'auto';
      }
    }

    // Toast notification
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      // Trigger animation
      setTimeout(() => toast.classList.add('show'), 10);
      
      // Remove after 3 seconds
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // WebSocket connection to register as a viewer (so we show up in "On Website" list)
    let ws;
    function connectWebSocket() {
      const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${wsProtocol}//${window.location.host}`);
      
      ws.onopen = () => {
        console.log('Connected to server (stats page)');
      };
      
      ws.onclose = () => {
        console.log('Disconnected from server, reconnecting...');
        setTimeout(connectWebSocket, 3000);
      };
      
      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
      };
    }
    
    // Connect to WebSocket
    connectWebSocket();

    // Load stats on page load
    loadStats();

    // Refresh stats every 30 seconds
    setInterval(loadStats, 30000);
  </script>
</body>
</html>